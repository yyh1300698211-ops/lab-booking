<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®éªŒå®¤å™¨æé¢„çº¦ç³»ç»Ÿ</title>
    
    <!-- 0. å…³é”®æ ·å¼ (åŸç”Ÿ CSSï¼Œä¸ä¾èµ– CDNï¼Œç¡®ä¿å‡ºé”™èƒ½çœ‹åˆ°) -->
    <style>
        /* åŸºç¡€é‡ç½® */
        body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; background: #f3f4f6; color: #1f2937; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* è°ƒè¯•/é”™è¯¯æ§åˆ¶å° - ç¡®ä¿æ°¸è¿œå¯è§ */
        #sys-console {
            display: none; position: fixed; bottom: 0; left: 0; right: 0; height: 200px;
            background: rgba(0,0,0,0.95); color: #00ff00; font-family: monospace; font-size: 13px;
            padding: 15px; overflow-y: auto; z-index: 99999; border-top: 3px solid #ff0000;
        }
        #sys-console .err { color: #ff5555; font-weight: bold; border-bottom: 1px solid #555; padding-bottom: 5px; margin-bottom: 5px; }
        #sys-console .warn { color: #ffaa00; }
        #sys-console .info { color: #88ccff; }

        /* åŠ è½½é®ç½© - åŸç”Ÿæ ·å¼ */
        #loading-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95); z-index: 50;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top: 4px solid #2563eb; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Tailwind è¾…åŠ©ç±» (å¦‚æœåŠ è½½å¤±è´¥ï¼Œè¿™äº› CSS ä¼šä½œä¸ºå¤‡ä»½) */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .h-full { height: 100%; }
        .bg-white { background-color: white; }
        .p-4 { padding: 1rem; }
        .border { border: 1px solid #e5e7eb; }
        
        /* æ—¥å†ç‰¹å®šæ ·å¼ */
        .sticky-header { position: sticky; top: 0; z-index: 10; background: #f3f4f6; }
        .sticky-time { position: sticky; left: 0; z-index: 5; background: #f3f4f6; }
        .sticky-header.sticky-time { z-index: 11; }
        .slot-cell { border-top: 1px solid #e5e7eb; border-left: 1px solid #e5e7eb; position: relative; }
        .slot-cell:hover { background-color: #f9fafb; }
        
        .dragging-select { background-color: rgba(191, 219, 254, 0.5); border-left: 4px solid #3b82f6; }
        .slot-locked { background-color: #e5e7eb; background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, #d1d5db 10px, #d1d5db 20px); cursor: not-allowed; }
        .booking-block { position: relative; margin: 1px; padding: 4px; color: white; font-size: 12px; border-radius: 4px; cursor: pointer; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .booking-mine { background-color: #3b82f6; border: 1px solid #1d4ed8; }
        .booking-other { background-color: #eab308; border: 1px solid #ca8a04; }
    </style>

    <!-- 1. èµ„æºåŠ è½½ç›‘æ§è„šæœ¬ -->
    <script>
        window.loadErrors = [];
        window.resourceCheck = function(name) {
            console.log(`[System] ${name} loaded.`);
            const log = document.getElementById('load-log');
            if(log) log.innerHTML += `<div>âœ… ${name} åŠ è½½æˆåŠŸ</div>`;
        };
        window.onerror = function(msg, url, line) {
            const errInfo = `âŒ é”™è¯¯: ${msg} (è¡Œ: ${line})`;
            window.loadErrors.push(errInfo);
            const consoleDiv = document.getElementById('sys-console');
            if(consoleDiv) {
                consoleDiv.style.display = 'block';
                consoleDiv.innerHTML += `<div class="err">${errInfo}<br><span style="font-weight:normal;color:#ccc">${url}</span></div>`;
            }
            // å¦‚æœæ˜¯å…³é”®é”™è¯¯ï¼Œå–æ¶ˆåŠ è½½åŠ¨ç”»
            if(msg.includes('dayjs') || msg.includes('supabase')) {
                const txt = document.getElementById('loading-text');
                if(txt) txt.innerHTML = '<span style="color:red">æ ¸å¿ƒåº“åŠ è½½å¤±è´¥ï¼Œè¯·çœ‹ä¸‹æ–¹æ§åˆ¶å°</span>';
            }
        };
    </script>

    <!-- 2. æ ¸å¿ƒåº“ (ä½¿ç”¨å›½å†…æœ€ç¨³å®šçš„ npm.elemecdn.com å’Œ baomitu) -->
    <script src="https://lib.baomitu.com/tailwindcss/2.2.19/tailwind.min.js" onload="resourceCheck('Tailwind')"></script>
    <script src="https://lib.baomitu.com/dayjs/1.11.10/dayjs.min.js" onload="resourceCheck('Day.js')"></script>
    <script src="https://lib.baomitu.com/dayjs/1.11.10/plugin/isoWeek.min.js"></script>
    <script src="https://lib.baomitu.com/dayjs/1.11.10/plugin/utc.min.js"></script>
    <script src="https://lib.baomitu.com/dayjs/1.11.10/plugin/timezone.min.js"></script>
    <script src="https://lib.baomitu.com/dayjs/1.11.10/plugin/weekday.min.js"></script>
    <!-- Supabase ä½¿ç”¨é¥¿äº†ä¹ˆCDN (æ·˜å®æº) -->
    <script src="https://npm.elemecdn.com/@supabase/supabase-js@2" onload="resourceCheck('Supabase')"></script>

</head>
<body>

    <!-- ç´§æ€¥è°ƒè¯•é¢æ¿ -->
    <div id="sys-console">
        <div style="position:sticky; top:0; background:#330; padding:5px; border-bottom:1px solid #550; display:flex; justify-content:space-between;">
            <strong>ç³»ç»Ÿè¯Šæ–­æ§åˆ¶å° (å‡ºç°é”™è¯¯è‡ªåŠ¨å¼¹å‡º)</strong>
            <button onclick="location.reload()" style="cursor:pointer;">åˆ·æ–°é¡µé¢</button>
        </div>
    </div>

    <!-- åŠ è½½é®ç½© -->
    <div id="loading-mask">
        <div class="spinner"></div>
        <div id="loading-text" style="font-weight:bold; color:#4b5563; margin-bottom:10px;">æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿ...</div>
        <div id="load-log" style="font-size:12px; color:#9ca3af; font-family:monospace;"></div>
    </div>

    <!-- ç™»å½•/å£ä»¤é®ç½© -->
    <div id="login-overlay" class="fixed inset-0 bg-gray-900 z-40 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm p-8 text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">å®éªŒå®¤é¢„çº¦ç³»ç»Ÿ</h2>
            <form id="login-form" class="space-y-4">
                <input type="password" id="access-code" class="w-full border border-gray-300 rounded px-4 py-2" placeholder="è¯·è¾“å…¥ç­çº§å£ä»¤">
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 rounded hover:bg-blue-700">è¿›å…¥</button>
                <p id="login-error" class="text-red-500 text-sm hidden">å£ä»¤é”™è¯¯</p>
            </form>
        </div>
    </div>

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="bg-white shadow p-4 z-30 flex-none">
        <div class="container mx-auto flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-4">
                <h1 class="text-xl font-bold text-blue-600">å™¨æé¢„çº¦</h1>
                <div class="flex items-center gap-2">
                    <input type="text" id="username-input" class="border rounded px-2 py-1 text-sm w-24" placeholder="å§“å">
                    <button id="username-confirm-btn" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">ç¡®è®¤</button>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <select id="equipment-select" class="border rounded px-2 py-1 text-sm w-40"></select>
                <button id="manage-btn" class="hidden bg-gray-200 px-2 py-1 rounded text-sm">âš™ï¸</button>
                <button id="refresh-btn" class="bg-gray-100 border px-2 py-1 rounded text-sm">âŸ³</button>
            </div>
            <div>
                <button id="toggle-view-btn" class="text-sm text-blue-600 mr-2">åˆ‡æ¢è§†å›¾</button>
                <button id="today-btn" class="text-sm bg-indigo-100 px-2 py-1 rounded">ä»Šå¤©</button>
            </div>
        </div>
    </header>

    <!-- çŠ¶æ€æ¡ -->
    <div id="status-bar" class="bg-blue-50 px-4 py-2 text-xs text-center border-b border-blue-100 hidden flex-none">
        å½“å‰: <span id="lbl-equip" class="font-bold text-blue-700">--</span> | ç”¨æˆ·: <span id="lbl-user" class="font-bold">--</span>
    </div>

    <!-- ä¸»åŒºåŸŸ -->
    <main class="flex-grow overflow-hidden relative container mx-auto p-2">
        <!-- å‘¨è§†å›¾ -->
        <div id="week-view" class="flex flex-col h-full">
            <div class="flex justify-between mb-2 flex-none">
                <button id="prev-w" class="border px-3 py-1 rounded text-sm">â† ä¸Šå‘¨</button>
                <strong id="week-title" class="text-lg"></strong>
                <button id="next-w" class="border px-3 py-1 rounded text-sm">ä¸‹å‘¨ â†’</button>
            </div>
            <div class="flex-grow overflow-auto border rounded bg-white relative" id="week-scroll">
                <div id="week-grid" class="grid" style="grid-template-columns: 50px repeat(7, minmax(100px, 1fr));"></div>
                <div id="empty-hint" class="hidden absolute inset-0 flex items-center justify-center text-gray-400">æš‚æ— å™¨æï¼Œè¯·ç®¡ç†å‘˜æ·»åŠ </div>
            </div>
        </div>

        <!-- æœˆè§†å›¾ -->
        <div id="month-view" class="hidden flex-col h-full">
            <div class="flex justify-between mb-2 flex-none">
                <button id="prev-m" class="border px-3 py-1 rounded text-sm">â† ä¸Šæœˆ</button>
                <strong id="month-title" class="text-lg"></strong>
                <button id="next-m" class="border px-3 py-1 rounded text-sm">ä¸‹æœˆ â†’</button>
            </div>
            <div id="month-grid" class="flex-grow overflow-auto border rounded bg-white grid grid-cols-7 gap-px bg-gray-200"></div>
        </div>
    </main>

    <!-- å¼¹çª— (åŸç”Ÿ CSS å®ç°æ˜¾éšï¼Œä¸ä¾èµ– class) -->
    <div id="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:100; align-items:center; justify-content:center;">
        <div class="bg-white rounded shadow-lg p-6 w-full max-w-md m-4">
            <h3 id="modal-title" class="text-lg font-bold mb-4"></h3>
            <div id="modal-content" class="mb-4 space-y-3"></div>
            <div class="flex justify-end gap-2" id="modal-actions"></div>
        </div>
    </div>

    <script>
        // --- é…ç½®åŒº ---
        const SUPABASE_URL = 'https://ajbuygcpdpiyinttmwdo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFqYnV5Z2NwZHBpeWludHRtd2RvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NTUyMTYsImV4cCI6MjA3OTUzMTIxNn0.8_cko-69pwVXy-AzWlwwhLxFOV4hvTvkhJoxo9ng06o';
        const CLASS_ACCESS_CODE = 'cxj123456';

        // --- åˆå§‹åŒ–é€»è¾‘ ---
        window.onload = async function() {
            // 1. å†æ¬¡æ£€æŸ¥åº“
            if (typeof dayjs === 'undefined' || typeof window.supabase === 'undefined') {
                document.getElementById('loading-text').innerHTML = '<span style="color:red">ä¾èµ–åº“åŠ è½½å¤±è´¥</span>';
                document.getElementById('sys-console').style.display = 'block';
                document.getElementById('sys-console').innerHTML += '<div class="err">Day.js æˆ– Supabase æœªåŠ è½½ã€‚è¯·æ£€æŸ¥ç½‘ç»œæˆ– CDNã€‚</div>';
                return;
            }

            // 2. æ³¨å†Œæ’ä»¶
            dayjs.extend(window.dayjs_plugin_isoWeek);
            dayjs.extend(window.dayjs_plugin_utc);
            dayjs.extend(window.dayjs_plugin_timezone);
            dayjs.extend(window.dayjs_plugin_weekday);
            dayjs.tz.setDefault(dayjs.tz.guess());

            // 3. è¿æ¥ Supabase
            let supabase;
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                // ç®€å•çš„è¿é€šæ€§æµ‹è¯•
                const { error } = await supabase.from('equipment').select('count', { count: 'exact', head: true });
                if (error && error.code !== 'PGRST116') { // PGRST116 æ˜¯æ— æ•°æ®ï¼Œä¸ç®—è¿æ¥é”™
                    console.error("Connection Test Failed", error);
                    // ä¸é˜»æ–­ï¼Œå› ä¸ºå¯èƒ½æ˜¯è¡¨æ²¡åˆ›å»ºï¼Œä½†è¦è®°å½•
                }
                document.getElementById('load-log').innerHTML += '<div>âœ… Supabase è¿æ¥åˆå§‹åŒ–</div>';
            } catch (e) {
                document.getElementById('sys-console').style.display = 'block';
                document.getElementById('sys-console').innerHTML += `<div class="err">Supabase è¿æ¥å¤±è´¥: ${e.message}</div>`;
                return;
            }

            // 4. è¿›å…¥åº”ç”¨
            const isAuth = localStorage.getItem('lab-auth') === 'true';
            document.getElementById('loading-mask').style.display = 'none'; // éšè—åŠ è½½å±‚
            
            if (isAuth) {
                startApp(supabase);
            } else {
                const loginOverlay = document.getElementById('login-overlay');
                loginOverlay.classList.remove('hidden'); // ä½¿ç”¨ Tailwind class æ˜¾ç¤º
                loginOverlay.style.display = 'flex'; // å¼ºåˆ¶æ˜¾ç¤ºä»¥é˜² Tailwind æŒ‚äº†
                
                document.getElementById('login-form').onsubmit = (e) => {
                    e.preventDefault();
                    const code = document.getElementById('access-code').value;
                    if (code === CLASS_ACCESS_CODE) {
                        localStorage.setItem('lab-auth', 'true');
                        loginOverlay.style.display = 'none';
                        startApp(supabase);
                    } else {
                        document.getElementById('login-error').style.display = 'block';
                    }
                };
            }
        };

        // --- æ ¸å¿ƒåº”ç”¨é€»è¾‘ ---
        function startApp(supabase) {
            let state = {
                user: localStorage.getItem('lab-user') || '',
                isAdmin: false,
                date: dayjs().startOf('day'),
                equipId: null,
                equips: [],
                bookings: [],
                locks: [],
                mode: 'week'
            };

            // DOM ç¼“å­˜
            const els = {
                userInp: document.getElementById('username-input'),
                eqSelect: document.getElementById('equipment-select'),
                wkGrid: document.getElementById('week-grid'),
                mnGrid: document.getElementById('month-grid'),
                modal: document.getElementById('modal-overlay'),
                mTitle: document.getElementById('modal-title'),
                mContent: document.getElementById('modal-content'),
                mActions: document.getElementById('modal-actions'),
                adminBtn: document.getElementById('manage-btn'),
                emptyHint: document.getElementById('empty-hint')
            };

            // è®¾ç½®åˆå§‹ UI
            els.userInp.value = state.user;
            updatePerms();

            // åŠ è½½æ•°æ®
            loadEquipments();

            // --- äº‹ä»¶ç»‘å®š ---
            document.getElementById('username-confirm-btn').onclick = () => {
                if(!els.userInp.value.trim()) return alert('è¯·è¾“å…¥å§“å');
                state.user = els.userInp.value.trim();
                localStorage.setItem('lab-user', state.user);
                updatePerms();
                updateStatus();
                alert(`ç”¨æˆ·åå·²æ›´æ–°: ${state.user}`);
                render();
            };

            document.getElementById('refresh-btn').onclick = () => loadEquipments();
            
            document.getElementById('today-btn').onclick = () => { state.date = dayjs(); loadData(); };
            document.getElementById('prev-w').onclick = () => { state.date = state.date.subtract(1, 'week'); loadData(); };
            document.getElementById('next-w').onclick = () => { state.date = state.date.add(1, 'week'); loadData(); };
            
            document.getElementById('toggle-view-btn').onclick = () => {
                state.mode = state.mode === 'week' ? 'month' : 'week';
                document.getElementById('week-view').style.display = state.mode === 'week' ? 'flex' : 'none';
                document.getElementById('month-view').style.display = state.mode === 'month' ? 'flex' : 'none';
                document.getElementById('toggle-view-btn').textContent = state.mode === 'week' ? 'æœˆè§†å›¾' : 'å‘¨è§†å›¾';
                loadData();
            };

            els.eqSelect.onchange = (e) => { state.equipId = e.target.value; loadData(); };

            // ç®¡ç†å™¨æ
            els.adminBtn.onclick = () => {
                showModal('ç®¡ç†å™¨æ', `
                    <div class="flex gap-2 mb-2">
                        <input id="new-eq" class="border p-1 flex-grow" placeholder="æ–°å™¨æå">
                        <button onclick="appAddEq()" class="bg-green-500 text-white px-3 py-1 rounded">æ·»åŠ </button>
                    </div>
                    <div class="max-h-60 overflow-y-auto border rounded">
                        ${state.equips.map(e => `
                            <div class="flex justify-between p-2 border-b">
                                <span>${e.name}</span>
                                <button onclick="appDelEq(${e.id})" class="text-red-500 text-sm">åˆ é™¤</button>
                            </div>
                        `).join('')}
                    </div>
                `, [{ text: 'å…³é—­', class: 'bg-gray-300', click: closeModal }]);
            };

            // å…¨å±€å‡½æ•°ä¾› HTML å­—ç¬¦ä¸²è°ƒç”¨
            window.appAddEq = async () => {
                const name = document.getElementById('new-eq').value;
                if(!name) return;
                await supabase.from('equipment').insert({ name });
                loadEquipments(); closeModal();
            };
            window.appDelEq = async (id) => {
                if(!confirm('ç¡®å®šåˆ é™¤ï¼Ÿæ•°æ®ä¸å¯æ¢å¤')) return;
                await supabase.from('equipment').delete().eq('id', id);
                loadEquipments(); closeModal();
            };

            // --- æ ¸å¿ƒé€»è¾‘ ---
            function updatePerms() {
                state.isAdmin = state.user === 'admins';
                els.adminBtn.style.display = state.isAdmin ? 'inline-block' : 'none';
            }

            function updateStatus() {
                const eqName = state.equips.find(e => e.id == state.equipId)?.name || '--';
                document.getElementById('lbl-equip').textContent = eqName;
                document.getElementById('lbl-user').textContent = state.user || 'æœªè®¾ç½®';
                document.getElementById('status-bar').style.display = 'block';
            }

            async function loadEquipments() {
                const { data, error } = await supabase.from('equipment').select('*').order('name');
                if(error) {
                    console.error(error);
                    document.getElementById('sys-console').style.display = 'block';
                    document.getElementById('sys-console').innerHTML += `<div class="err">å™¨æåŠ è½½å¤±è´¥: ${error.message}</div>`;
                    return;
                }
                state.equips = data;
                els.eqSelect.innerHTML = '';
                
                if(data.length === 0) {
                    els.eqSelect.innerHTML = '<option>æ— å™¨æ</option>';
                    state.equipId = null;
                    els.emptyHint.style.display = 'flex';
                } else {
                    els.emptyHint.style.display = 'none';
                    data.forEach(e => {
                        const opt = document.createElement('option');
                        opt.value = e.id; opt.textContent = e.name;
                        els.eqSelect.appendChild(opt);
                    });
                    if (!state.equipId) state.equipId = data[0].id;
                    els.eqSelect.value = state.equipId;
                    loadData();
                }
            }

            async function loadData() {
                if(!state.equipId) return;
                
                updateStatus();
                document.getElementById('week-title').textContent = state.date.format('YYYY-MM-DD');
                document.getElementById('month-title').textContent = state.date.format('YYYY-MM');

                // å¹¶è¡ŒåŠ è½½
                const [bRes, lRes] = await Promise.all([
                    supabase.from('bookings').select('*').eq('equipment_id', state.equipId),
                    supabase.from('locked_dates').select('*').eq('equipment_id', state.equipId)
                ]);

                if(bRes.error || lRes.error) return alert("æ•°æ®åŒæ­¥é”™è¯¯");

                state.bookings = bRes.data.map(b => ({ ...b, start: dayjs(b.start_time), end: dayjs(b.end_time) }));
                state.locks = lRes.data.map(l => l.lock_date);
                
                render();
            }

            function render() {
                if(state.mode === 'week') renderWeek();
                else renderMonth();
            }

            // ç®€å•çš„å‘¨è§†å›¾æ¸²æŸ“
            function renderWeek() {
                els.wkGrid.innerHTML = '';
                // æ—¶é—´è½´
                els.wkGrid.appendChild(makeCell('sticky-header sticky-time p-2 bg-gray-100', ''));
                
                // è¡¨å¤´
                const startWeek = state.date.weekday(0);
                for(let i=0; i<7; i++) {
                    const d = startWeek.add(i, 'day');
                    const dStr = d.format('YYYY-MM-DD');
                    const isLocked = state.locks.includes(dStr);
                    const lockIcon = state.isAdmin ? `<span onclick="toggleLock('${dStr}', ${isLocked})" class="cursor-pointer ml-1">${isLocked?'ğŸ”’':'ğŸ”“'}</span>` : (isLocked?'ğŸ”’':'');
                    
                    els.wkGrid.appendChild(makeCell('sticky-header p-2 text-center border-b border-l bg-gray-50', 
                        `<div>${d.format('MM/DD')} ${lockIcon}</div>`));
                }

                // æ—¶é—´æ ¼
                for(let h=0; h<24; h++) {
                    els.wkGrid.appendChild(makeCell('sticky-time p-1 text-xs text-right border-t bg-gray-50', `${h}:00`));
                    
                    for(let d=0; d<7; d++) {
                        const day = startWeek.add(d, 'day');
                        const dStr = day.format('YYYY-MM-DD');
                        const isLocked = state.locks.includes(dStr);
                        const timeIso = day.hour(h).minute(0).second(0).toISOString();
                        
                        const cell = makeCell(`slot-cell h-10 ${isLocked?'slot-locked':'bg-white'}`, '');
                        cell.dataset.time = timeIso;
                        cell.dataset.col = d;
                        
                        if(!isLocked) {
                            cell.onmousedown = handleDragStart;
                            cell.onmouseenter = handleDragEnter;
                        }
                        els.wkGrid.appendChild(cell);
                    }
                }

                // æ¸²æŸ“é¢„çº¦å—
                state.bookings.forEach(b => {
                    // ç®€å•è¿‡æ»¤æœ¬å‘¨
                    if(b.start.isBefore(startWeek) || b.start.isAfter(startWeek.add(7, 'day'))) return;
                    
                    const col = b.start.diff(startWeek, 'day');
                    const startH = b.start.hour();
                    const duration = b.end.diff(b.start, 'hour');
                    
                    const div = document.createElement('div');
                    const isMine = b.user_id === state.user;
                    div.className = `booking-block ${isMine ? 'booking-mine' : 'booking-other'}`;
                    div.style.gridColumn = col + 2; // +2 å› ä¸ºç¬¬ä¸€åˆ—æ˜¯æ—¶é—´
                    div.style.gridRow = `${startH + 2} / span ${duration}`;
                    div.innerHTML = `<strong>${isMine?'æˆ‘':b.user_id}</strong><br>${b.remarks||''}`;
                    div.onclick = (e) => { e.stopPropagation(); showBookingDetail(b); };
                    
                    els.wkGrid.appendChild(div);
                });
            }

            function renderMonth() {
                els.mnGrid.innerHTML = '';
                const startMonth = state.date.startOf('month');
                const startGrid = startMonth.weekday(0);
                
                // è¡¨å¤´
                ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(t => 
                    els.mnGrid.appendChild(makeCell('text-center font-bold p-2 bg-gray-100', t))
                );

                for(let i=0; i<42; i++) {
                    const d = startGrid.add(i, 'day');
                    const isCurr = d.month() === startMonth.month();
                    const users = [...new Set(state.bookings.filter(b => b.start.format('YYYY-MM-DD') === d.format('YYYY-MM-DD')).map(b => b.user_id))];
                    
                    els.mnGrid.appendChild(makeCell(`h-24 p-1 border ${isCurr?'bg-white':'bg-gray-50 text-gray-400'}`, 
                        `<div class="text-right text-xs font-bold">${d.date()}</div>
                         <div class="overflow-y-auto h-16 text-xs mt-1">
                            ${users.map(u => `<span class="bg-blue-100 px-1 rounded mr-1 mb-1 inline-block">${u}</span>`).join('')}
                         </div>`
                    ));
                }
            }

            // --- äº¤äº’åŠ¨ä½œ ---
            window.toggleLock = async (dateStr, isLocked) => {
                if(isLocked) await supabase.from('locked_dates').delete().eq('equipment_id', state.equipId).eq('lock_date', dateStr);
                else await supabase.from('locked_dates').insert({ equipment_id: state.equipId, lock_date: dateStr });
                loadData();
            };

            // æ‹–æ‹½é€»è¾‘
            let isDragging = false, startSlot = null, selectedSlots = [];
            
            function handleDragStart(e) {
                isDragging = true; startSlot = e.target; selectedSlots = [e.target];
                e.target.classList.add('dragging-select');
            }
            
            function handleDragEnter(e) {
                if(!isDragging || e.target.dataset.col !== startSlot.dataset.col) return;
                // ç®€å•æ¸…é™¤å¹¶é‡ç»˜
                document.querySelectorAll('.dragging-select').forEach(el => el.classList.remove('dragging-select'));
                selectedSlots = [];
                
                // æ‰¾åˆ°èŒƒå›´
                const all = Array.from(document.querySelectorAll(`[data-col="${startSlot.dataset.col}"]`));
                const i1 = all.indexOf(startSlot), i2 = all.indexOf(e.target);
                const [min, max] = i1 < i2 ? [i1, i2] : [i2, i1];
                
                let valid = true;
                for(let i=min; i<=max; i++) {
                    if(all[i].classList.contains('slot-locked')) valid = false;
                    all[i].classList.add('dragging-select');
                    selectedSlots.push(all[i]);
                }
                if(!valid) { // é‡åˆ°é”å®šåˆ™å–æ¶ˆ
                    selectedSlots.forEach(el => el.classList.remove('dragging-select'));
                    selectedSlots = [];
                }
            }
            
            window.addEventListener('mouseup', () => {
                if(!isDragging) return;
                isDragging = false;
                if(selectedSlots.length > 0) openBookingModal(selectedSlots);
                setTimeout(() => document.querySelectorAll('.dragging-select').forEach(el => el.classList.remove('dragging-select')), 100);
            });

            // --- å¼¹çª—é€»è¾‘ ---
            function showModal(title, htmlContent, actions) {
                els.mTitle.textContent = title;
                els.mContent.innerHTML = htmlContent;
                els.mActions.innerHTML = '';
                
                actions.forEach(a => {
                    const btn = document.createElement('button');
                    btn.textContent = a.text;
                    btn.className = `px-4 py-2 rounded text-sm ${a.class || 'bg-gray-200'}`;
                    btn.onclick = a.click;
                    els.mActions.appendChild(btn);
                });
                els.modal.style.display = 'flex';
            }
            
            window.closeModal = () => { els.modal.style.display = 'none'; };

            function openBookingModal(slots) {
                if(!state.user || state.user === 'admins') return alert("è¯·å…ˆåœ¨é¡¶éƒ¨è®¾ç½®æœ‰æ•ˆçš„ç”¨æˆ·å");
                
                const times = slots.map(s => dayjs(s.dataset.time)).sort((a,b) => a - b);
                const start = times[0], end = times[times.length-1].add(1, 'hour');
                
                showModal('æ–°å»ºé¢„çº¦', `
                    <div><strong>æ—¶é—´:</strong> ${start.format('MM-DD HH:mm')} - ${end.format('HH:mm')}</div>
                    <textarea id="b-note" class="w-full border p-2 mt-2" placeholder="å¤‡æ³¨..."></textarea>
                `, [
                    { text: 'å–æ¶ˆ', click: closeModal },
                    { text: 'ç¡®è®¤é¢„çº¦', class: 'bg-blue-600 text-white', click: async () => {
                        const remarks = document.getElementById('b-note').value;
                        const inserts = times.map(t => ({
                            equipment_id: state.equipId,
                            user_id: state.user,
                            remarks,
                            start_time: t.toISOString(),
                            end_time: t.add(1, 'hour').toISOString()
                        }));
                        const { error } = await supabase.from('bookings').insert(inserts);
                        if(error) alert('é¢„çº¦å¤±è´¥:' + error.message);
                        else { closeModal(); loadData(); }
                    }}
                ]);
            }

            function showBookingDetail(b) {
                const isMine = b.user_id === state.user;
                const canEdit = isMine || state.isAdmin;
                
                // æŸ¥æ‰¾æ‰€æœ‰å±äºåŒä¸€æ‰¹æ¬¡çš„ IDï¼ˆç›¸åŒç”¨æˆ·ã€è®¾å¤‡ã€å¤‡æ³¨ã€è¿ç»­æ—¶é—´ï¼‰
                // ç®€åŒ–ï¼šåªåˆ é™¤å½“å‰ç‚¹å‡»çš„è¿™ä¸€ä¸ªå—ï¼Œæˆ–è€…ç®€å•çš„æ ¹æ®IDåˆ é™¤
                // åœ¨æ­¤ç®€åŒ–ç‰ˆä¸­ï¼Œæˆ‘ä»¬åˆ é™¤å•æ¡è®°å½•ï¼Œæˆ–è€…ä½ å¯ä»¥æ‰©å±•ä¸ºåˆ é™¤åŒä¸€ç»„
                
                let actions = [{ text: 'å…³é—­', click: closeModal }];
                
                if(canEdit) {
                    actions.unshift({
                        text: 'åˆ é™¤é¢„çº¦',
                        class: 'bg-red-500 text-white',
                        click: async () => {
                            if(!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
                            // ç®€å•åˆ é™¤å•ä¸ªIDï¼Œå¦‚æœæ˜¯ä¸€æ‰¹æ¬¡æ’å…¥çš„ï¼Œé€»è¾‘ä¸Šåº”è¯¥åˆ é™¤å…³è”çš„ï¼Œä½†è¿™é‡ŒIDç‹¬ç«‹
                            await supabase.from('bookings').delete().eq('id', b.id);
                            closeModal(); loadData();
                        }
                    });
                    actions.unshift({
                        text: 'æ›´æ–°å¤‡æ³¨',
                        class: 'bg-blue-500 text-white',
                        click: async () => {
                            const newR = document.getElementById('d-note').value;
                            await supabase.from('bookings').update({ remarks: newR }).eq('id', b.id);
                            closeModal(); loadData();
                        }
                    });
                }

                showModal('é¢„çº¦è¯¦æƒ…', `
                    <div><strong>ç”¨æˆ·:</strong> ${b.user_id}</div>
                    <div><strong>æ—¶é—´:</strong> ${b.start.format('MM-DD HH:mm')}</div>
                    <textarea id="d-note" class="w-full border p-2 mt-2" ${!canEdit?'disabled':''}>${b.remarks||''}</textarea>
                `, actions);
            }

            function makeCell(cls, html) {
                const d = document.createElement('div');
                d.className = cls; d.innerHTML = html;
                return d;
            }
        }
    </script>
</body>
</html>

