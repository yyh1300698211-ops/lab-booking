<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®éªŒå®¤å™¨æé¢„çº¦ç³»ç»Ÿ</title>
    
    <!-- 1. æ ¸å¿ƒ JS åº“ (ä½¿ç”¨å›½å†… Staticfile æº) -->
    <script src="https://cdn.staticfile.org/dayjs/1.11.10/dayjs.min.js"></script>
    <script src="https://cdn.staticfile.org/dayjs/1.11.10/plugin/isoWeek.min.js"></script>
    <script src="https://cdn.staticfile.org/dayjs/1.11.10/plugin/utc.min.js"></script>
    <script src="https://cdn.staticfile.org/dayjs/1.11.10/plugin/timezone.min.js"></script>
    <script src="https://cdn.staticfile.org/dayjs/1.11.10/plugin/weekday.min.js"></script>
    <!-- Supabase (ä½¿ç”¨é¥¿äº†ä¹ˆæº) -->
    <script src="https://npm.elemecdn.com/@supabase/supabase-js@2"></script>

    <!-- 2. åŸç”Ÿ CSS æ ·å¼ -->
    <style>
        :root {
            --primary: #2563eb; --primary-hover: #1d4ed8;
            --bg: #f3f4f6; --white: #ffffff;
            --text: #1f2937; --text-light: #6b7280;
            --border: #e5e7eb;
            --red: #ef4444; --yellow: #eab308;
        }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: -apple-system, "Microsoft YaHei", sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* é€šç”¨ç»„ä»¶ */
        button { cursor: pointer; border: 1px solid transparent; padding: 6px 12px; border-radius: 4px; font-size: 14px; transition: all 0.2s; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-danger { background: #fee2e2; color: #b91c1c; border-color: #fca5a5; }
        .btn-danger:hover { background: #fecaca; }
        .btn-outline { background: white; border-color: var(--border); color: var(--text); }
        .btn-outline:hover { background: #f9fafb; }
        
        input, select, textarea { padding: 6px 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 14px; outline: none; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37,99,235,0.2); }

        /* å¸ƒå±€ */
        header { background: var(--white); padding: 10px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; z-index: 20; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .header-left, .header-right { display: flex; align-items: center; gap: 10px; }
        .title { font-size: 18px; font-weight: bold; color: var(--primary); margin-right: 10px; display: flex; align-items: center; gap: 5px; }
        
        main { flex: 1; overflow: hidden; padding: 15px; display: flex; flex-direction: column; }
        
        /* çŠ¶æ€æ  */
        #status-bar { background: #eff6ff; border: 1px solid #dbeafe; color: #1e3a8a; padding: 8px 15px; border-radius: 6px; margin-bottom: 15px; display: flex; justify-content: space-between; font-size: 13px; display: none; }
        
        /* è§†å›¾æ§åˆ¶ */
        .view-controls { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; }
        .view-title { font-size: 16px; font-weight: bold; }

        /* ç½‘æ ¼å®¹å™¨ */
        .grid-wrapper { background: var(--white); border: 1px solid var(--border); border-radius: 8px; overflow: auto; position: relative; flex: 1; display: flex; flex-direction: column; }
        
        /* æç¤ºå±‚ (é”™è¯¯/ç©ºçŠ¶æ€) */
        .overlay-msg { position: absolute; inset: 0; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; display: none; text-align: center; }
        .overlay-msg p { color: var(--text-light); margin: 5px 0; }
        .overlay-msg.show { display: flex; }

        /* å‘¨è§†å›¾ç½‘æ ¼ */
        #week-grid { display: grid; grid-template-columns: 60px repeat(7, minmax(120px, 1fr)); min-height: 100%; }
        
        .sticky-header { position: sticky; top: 0; background: #f9fafb; z-index: 5; border-bottom: 1px solid var(--border); border-left: 1px solid var(--border); padding: 8px; text-align: center; font-weight: 500; }
        .sticky-time { position: sticky; left: 0; background: #f9fafb; z-index: 4; border-top: 1px solid var(--border); padding: 5px; font-size: 12px; text-align: right; color: var(--text-light); }
        /* å·¦ä¸Šè§’ç©ºç™½æ ¼ */
        .sticky-header.sticky-time { z-index: 6; border: none; border-bottom: 1px solid var(--border); }

        .cell { border-top: 1px solid var(--border); border-left: 1px solid var(--border); position: relative; height: 40px; }
        .cell:hover { background: #f3f4f6; }
        
        /* é¢„çº¦å— */
        .booking-block {
            position: absolute; margin: 2px; padding: 4px 6px; border-radius: 4px; 
            color: white; font-size: 12px; cursor: pointer; overflow: hidden; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.2); z-index: 2;
            left: 0; right: 0;
        }
        .booking-mine { background: var(--primary); border: 1px solid #1d4ed8; }
        .booking-other { background: var(--yellow); border: 1px solid #ca8a04; color: #713f12; }
        
        /* çŠ¶æ€ç±» */
        .slot-locked { background: #e5e7eb; background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, #d1d5db 10px, #d1d5db 20px); cursor: not-allowed; }
        .dragging { background: rgba(37, 99, 235, 0.3); border-left: 3px solid var(--primary); }
        .hidden { display: none !important; }

        /* æœˆè§†å›¾ */
        #month-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border); flex: 1; }
        .month-cell { background: var(--white); min-height: 80px; padding: 5px; }
        .month-head { background: #f9fafb; padding: 10px; text-align: center; font-weight: bold; }
        .user-tag { display: inline-block; background: #dbeafe; color: #1e40af; font-size: 12px; padding: 1px 4px; border-radius: 3px; margin: 1px; }

        /* å¼¹çª— */
        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal { background: white; width: 90%; max-width: 400px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; }
        .modal-header { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 15px; background: #f9fafb; text-align: right; display: flex; justify-content: flex-end; gap: 10px; }
        .close-btn { background: none; border: none; font-size: 20px; color: #999; cursor: pointer; }

        /* ç™»å½•é®ç½© */
        #login-layer { position: fixed; inset: 0; background: #111827; z-index: 200; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 350px; text-align: center; }
        
        /* è°ƒè¯•é¢æ¿ */
        #debug-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #333; color: #faaaaa; font-size: 12px; padding: 5px; display: none; z-index: 9999; max-height: 100px; overflow: auto; }
    </style>

    <script>
        // å…¨å±€é”™è¯¯æ•è·
        window.onerror = function(msg, url, line) {
            const bar = document.getElementById('debug-bar');
            if(bar) {
                bar.style.display = 'block';
                bar.innerHTML += `âŒ ${msg} (Line:${line}) <br>`;
            }
        };
    </script>
</head>
<body>

    <!-- è°ƒè¯•æ¡ -->
    <div id="debug-bar"></div>

    <!-- ç™»å½•å±‚ -->
    <div id="login-layer">
        <div class="login-box">
            <h2 style="margin-top:0; color:#333;">å®éªŒå®¤é¢„çº¦</h2>
            <p style="color:#666; font-size:14px;">è¯·è¾“å…¥ç­çº§å£ä»¤</p>
            <form id="login-form" style="margin-top:20px;">
                <input type="password" id="access-code" placeholder="å£ä»¤..." style="width:100%; padding:10px; margin-bottom:15px;">
                <button type="submit" class="btn-primary" style="width:100%; padding:10px;">è¿›å…¥ç³»ç»Ÿ</button>
                <p id="login-error" style="color:red; font-size:12px; display:none; margin-top:10px;">å£ä»¤é”™è¯¯</p>
            </form>
        </div>
    </div>

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header>
        <div class="header-left">
            <div class="title">ğŸ”¬ å™¨æé¢„çº¦</div>
            <div style="display:flex; gap:5px; align-items:center;">
                <input id="username-inp" placeholder="å§“å" style="width:80px;">
                <button id="username-btn" class="btn-primary">ç¡®è®¤</button>
            </div>
        </div>
        <div class="header-right">
            <select id="eq-select" style="width:120px;"></select>
            <button id="admin-btn" class="btn-outline" style="display:none;" title="ç®¡ç†">âš™ï¸</button>
            <button id="refresh-btn" class="btn-outline" title="åˆ·æ–°æ•°æ®">âŸ³</button>
            <button id="view-btn" class="btn-primary">æœˆè§†å›¾</button>
            <button id="today-btn" class="btn-outline">ä»Šå¤©</button>
            <button id="logout-btn" class="btn-danger" title="é€€å‡º">é€€å‡º</button>
        </div>
    </header>

    <!-- ä¸»ç•Œé¢ -->
    <main>
        <div id="status-bar">
            <span>å½“å‰å™¨æ: <b id="st-eq">--</b></span>
            <span>å½“å‰ç”¨æˆ·: <b id="st-user">--</b></span>
        </div>

        <!-- å‘¨è§†å›¾ -->
        <div id="week-view" style="display:flex; flex-direction:column; height:100%;">
            <div class="view-controls">
                <button id="w-prev" class="btn-outline">â† ä¸Šå‘¨</button>
                <span id="w-title" class="view-title">...</span>
                <button id="w-next" class="btn-outline">ä¸‹å‘¨ â†’</button>
            </div>
            <div class="grid-wrapper">
                <!-- åŠ è½½/é”™è¯¯æç¤º -->
                <div id="msg-layer" class="overlay-msg">
                    <div style="font-size:24px; margin-bottom:10px;">ğŸ“¡</div>
                    <p id="msg-text">æ­£åœ¨è¿æ¥æ•°æ®åº“...</p>
                    <button id="retry-btn" class="btn-primary" style="display:none; margin-top:10px;">é‡è¯•</button>
                </div>
                
                <div id="week-grid"></div>
            </div>
        </div>

        <!-- æœˆè§†å›¾ -->
        <div id="month-view" class="hidden" style="flex-direction:column; height:100%;">
            <div class="view-controls">
                <button id="m-prev" class="btn-outline">â† ä¸Šæœˆ</button>
                <span id="m-title" class="view-title">...</span>
                <button id="m-next" class="btn-outline">ä¸‹æœˆ â†’</button>
            </div>
            <div class="grid-wrapper">
                <div id="month-grid"></div>
            </div>
        </div>
    </main>

    <!-- å¼¹çª—å®¹å™¨ -->
    <div id="modal-overlay" class="modal-backdrop">
        <div class="modal">
            <div class="modal-header">
                <span id="modal-title">æ ‡é¢˜</span>
                <button class="close-btn" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body" id="modal-content"></div>
            <div class="modal-footer" id="modal-actions"></div>
        </div>
    </div>

    <script>
        // ================= é…ç½® =================
        const SUPABASE_URL = 'https://ajbuygcpdpiyinttmwdo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFqYnV5Z2NwZHBpeWludHRtd2RvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NTUyMTYsImV4cCI6MjA3OTUzMTIxNn0.8_cko-69pwVXy-AzWlwwhLxFOV4hvTvkhJoxo9ng06o';
        const CLASS_ACCESS_CODE = 'cxj123456';
        // =======================================

        let supabase;
        let state = {
            user: localStorage.getItem('lab-user') || '',
            isAdmin: false,
            date: null, // ç¨ååˆå§‹åŒ–
            equipId: null,
            equips: [], bookings: [], locks: [],
            mode: 'week'
        };

        // DOM ç¼“å­˜
        const dom = {
            login: document.getElementById('login-layer'),
            msg: document.getElementById('msg-layer'),
            msgText: document.getElementById('msg-text'),
            retryBtn: document.getElementById('retry-btn'),
            wkGrid: document.getElementById('week-grid'),
            mnGrid: document.getElementById('month-grid'),
            modal: document.getElementById('modal-overlay'),
            mTitle: document.getElementById('modal-title'),
            mBody: document.getElementById('modal-content'),
            mFoot: document.getElementById('modal-actions'),
            eqSel: document.getElementById('eq-select')
        };

        // --- åˆå§‹åŒ–æµç¨‹ ---
        window.onload = function() {
            // 1. æ£€æŸ¥åº“
            if (typeof dayjs === 'undefined') return alert('æ ¸å¿ƒåº“ Day.js åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°ã€‚');
            
            // 2. æ³¨å†Œæ’ä»¶
            dayjs.extend(window.dayjs_plugin_isoWeek);
            dayjs.extend(window.dayjs_plugin_utc);
            dayjs.extend(window.dayjs_plugin_timezone);
            dayjs.extend(window.dayjs_plugin_weekday);
            dayjs.tz.setDefault(dayjs.tz.guess());
            state.date = dayjs().startOf('day');

            // 3. æ£€æŸ¥ç™»å½•
            if (localStorage.getItem('lab-auth') === 'true') {
                dom.login.style.display = 'none';
                initApp();
            } else {
                document.getElementById('login-form').onsubmit = (e) => {
                    e.preventDefault();
                    if (document.getElementById('access-code').value === CLASS_ACCESS_CODE) {
                        localStorage.setItem('lab-auth', 'true');
                        dom.login.style.display = 'none';
                        initApp();
                    } else {
                        document.getElementById('login-error').style.display = 'block';
                    }
                };
            }
        };

        function initApp() {
            if (!window.supabase) return showMsg('Supabase åº“åŠ è½½å¤±è´¥', true);
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            } catch(e) {
                return showMsg('æ•°æ®åº“è¿æ¥åˆå§‹åŒ–å¤±è´¥: ' + e.message, true);
            }

            // æ¢å¤ UI çŠ¶æ€
            document.getElementById('username-inp').value = state.user;
            checkAdmin();
            
            // å¼€å§‹æ‹‰å–æ•°æ®
            fetchEquipments();
        }

        // --- æ•°æ®å±‚ ---
        async function fetchEquipments() {
            showMsg('æ­£åœ¨åŠ è½½å™¨æåˆ—è¡¨...');
            const { data, error } = await supabase.from('equipment').select('*').order('name');
            
            if (error) return showMsg('åŠ è½½å¤±è´¥: ' + error.message, true);
            
            state.equips = data || [];
            dom.eqSel.innerHTML = '';

            if (state.equips.length === 0) {
                dom.eqSel.innerHTML = '<option>æš‚æ— å™¨æ</option>';
                state.equipId = null;
                showMsg('æš‚æ— å™¨ææ•°æ®<br>è¯·åœ¨ä¸Šæ–¹è¾“å…¥ "admins" å¹¶ç¡®è®¤ï¼Œç„¶åç‚¹å‡» âš™ï¸ æ·»åŠ ', false);
                return;
            }

            state.equips.forEach(e => {
                const opt = document.createElement('option');
                opt.value = e.id; opt.textContent = e.name;
                dom.eqSel.appendChild(opt);
            });

            // æ¢å¤é€‰æ‹©
            if (state.equipId && state.equips.find(e => e.id == state.equipId)) {
                dom.eqSel.value = state.equipId;
            } else {
                state.equipId = state.equips[0].id;
                dom.eqSel.value = state.equipId;
            }

            fetchData();
        }

        async function fetchData() {
            if (!state.equipId) return;
            
            // åªæœ‰åœ¨ç¬¬ä¸€æ¬¡æˆ–è€…æ‰‹åŠ¨åˆ·æ–°æ—¶æ˜¾ç¤º loadingï¼Œé¿å…é—ªçƒ
            if(dom.wkGrid.innerHTML === '') showMsg('æ•°æ®åŒæ­¥ä¸­...');
            
            const [bRes, lRes] = await Promise.all([
                supabase.from('bookings').select('*').eq('equipment_id', state.equipId),
                supabase.from('locked_dates').select('lock_date').eq('equipment_id', state.equipId)
            ]);

            if (bRes.error || lRes.error) return showMsg('æ•°æ®åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', true);

            state.bookings = (bRes.data || []).map(b => ({ ...b, start: dayjs(b.start_time), end: dayjs(b.end_time) }));
            state.locks = (lRes.data || []).map(l => l.lock_date);

            hideMsg();
            updateStatus();
            render();
        }

        // --- æ¸²æŸ“å±‚ ---
        function render() {
            state.mode === 'week' ? renderWeek() : renderMonth();
        }

        function renderWeek() {
            dom.wkGrid.innerHTML = '';
            document.getElementById('week-view').style.display = 'flex';
            document.getElementById('month-view').classList.add('hidden');
            document.getElementById('week-title').textContent = state.date.format('YYYY-MM-DD');

            // 1. å·¦ä¸Šè§’ç©ºå—
            dom.wkGrid.appendChild(makeDiv('sticky-header sticky-time', ''));

            // 2. è¡¨å¤´
            const startWeek = state.date.weekday(0);
            for (let i = 0; i < 7; i++) {
                const d = startWeek.add(i, 'day');
                const dStr = d.format('YYYY-MM-DD');
                const isLocked = state.locks.includes(dStr);
                const lockBtn = state.isAdmin ? `<span onclick="toggleLock('${dStr}', ${isLocked})" style="cursor:pointer;margin-left:5px;">${isLocked?'ğŸ”’':'ğŸ”“'}</span>` : (isLocked?'ğŸ”’':'');
                dom.wkGrid.appendChild(makeDiv('sticky-header', `${d.format('MM/DD')} ${lockBtn}`));
            }

            // 3. ç½‘æ ¼å†…å®¹
            for (let h = 0; h < 24; h++) {
                // æ—¶é—´åˆ—
                dom.wkGrid.appendChild(makeDiv('sticky-time', `${h}:00`));
                
                for (let d = 0; d < 7; d++) {
                    const date = startWeek.add(d, 'day');
                    const dStr = date.format('YYYY-MM-DD');
                    const isLocked = state.locks.includes(dStr);
                    const timeIso = date.hour(h).minute(0).second(0).toISOString();
                    
                    const cell = makeDiv(`cell ${isLocked?'slot-locked':''}`, '');
                    cell.dataset.time = timeIso;
                    cell.dataset.col = d;
                    
                    if (!isLocked) {
                        cell.onmousedown = handleDragStart;
                        cell.onmouseenter = handleDragEnter;
                    }
                    dom.wkGrid.appendChild(cell);
                }
            }

            // 4. æ¸²æŸ“é¢„çº¦å—
            state.bookings.forEach(b => {
                if (b.start.isBefore(startWeek) || b.start.isAfter(startWeek.add(7, 'day'))) return;
                
                const col = b.start.diff(startWeek, 'day') + 2; // +2 offset
                const startRow = b.start.hour() + 2;
                const span = b.end.diff(b.start, 'hour');
                
                const isMine = b.user_id === state.user;
                const div = makeDiv(`booking-block ${isMine?'booking-mine':'booking-other'}`, 
                    `<strong>${isMine?'æˆ‘':b.user_id}</strong><br>${b.remarks||''}`);
                
                div.style.gridColumn = col;
                div.style.gridRow = `${startRow} / span ${span}`;
                div.onclick = (e) => { e.stopPropagation(); showDetail(b); };
                
                dom.wkGrid.appendChild(div);
            });
        }

        function renderMonth() {
            dom.mnGrid.innerHTML = '';
            document.getElementById('week-view').style.display = 'none';
            document.getElementById('month-view').classList.remove('hidden');
            document.getElementById('month-title').textContent = state.date.format('YYYYå¹´MMæœˆ');

            // è¡¨å¤´
            ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(t => 
                dom.mnGrid.appendChild(makeDiv('month-head', t))
            );

            const startMonth = state.date.startOf('month');
            const startGrid = startMonth.weekday(0);

            for(let i=0; i<42; i++) {
                const d = startGrid.add(i, 'day');
                const isCurr = d.month() === startMonth.month();
                const users = [...new Set(state.bookings.filter(b => b.start.isSame(d, 'day')).map(b => b.user_id))];
                
                const html = `<div style="text-align:right;font-size:12px;font-weight:bold;">${d.date()}</div>
                              <div>${users.map(u => `<span class="user-tag">${u}</span>`).join('')}</div>`;
                
                dom.mnGrid.appendChild(makeDiv(`month-cell ${isCurr?'':'bg-gray'}`, html));
            }
        }

        // --- äº¤äº’é€»è¾‘ ---
        let isDragging = false, startSlot = null, selectedSlots = [];

        function handleDragStart(e) {
            isDragging = true; startSlot = e.target; selectedSlots = [e.target];
            e.target.classList.add('dragging');
        }

        function handleDragEnter(e) {
            if (!isDragging || e.target.dataset.col !== startSlot.dataset.col) return;
            // é‡ç»˜é€‰ä¸­åŒºåŸŸ
            document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
            selectedSlots = [];
            
            const colCells = Array.from(document.querySelectorAll(`[data-col="${startSlot.dataset.col}"]`));
            const i1 = colCells.indexOf(startSlot);
            const i2 = colCells.indexOf(e.target);
            const [min, max] = i1 < i2 ? [i1, i2] : [i2, i1];
            
            let valid = true;
            for(let i=min; i<=max; i++) {
                if(colCells[i].classList.contains('slot-locked')) valid = false;
                colCells[i].classList.add('dragging');
                selectedSlots.push(colCells[i]);
            }
            if(!valid) {
                selectedSlots.forEach(el => el.classList.remove('dragging'));
                selectedSlots = [];
            }
        }

        window.addEventListener('mouseup', () => {
            if (!isDragging) return;
            isDragging = false;
            if (selectedSlots.length > 0) openBookingModal(selectedSlots);
            setTimeout(() => document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging')), 100);
        });

        // --- å¼¹çª—é€»è¾‘ ---
        function showModal(title, bodyHtml, buttons) {
            document.getElementById('modal-title').textContent = title;
            dom.mBody.innerHTML = bodyHtml;
            dom.mFoot.innerHTML = '';
            buttons.forEach(btn => {
                const b = document.createElement('button');
                b.textContent = btn.text;
                b.className = btn.cls || 'btn-outline';
                b.onclick = btn.click;
                dom.mFoot.appendChild(b);
            });
            dom.modal.style.display = 'flex';
        }
        
        window.closeModal = () => dom.modal.style.display = 'none';

        function openBookingModal(slots) {
            if (!state.user || state.user === 'admins') return alert("è¯·å…ˆè®¾ç½®æœ‰æ•ˆçš„ç”¨æˆ·å");
            
            const times = slots.map(s => dayjs(s.dataset.time)).sort((a,b) => a - b);
            const start = times[0];
            const end = times[times.length-1].add(1, 'hour');
            
            showModal('æ–°å»ºé¢„çº¦', `
                <p><strong>æ—¶é—´ï¼š</strong>${start.format('MM-DD HH:mm')} - ${end.format('HH:mm')}</p>
                <textarea id="bk-note" style="width:100%;" rows="3" placeholder="å¤‡æ³¨..."></textarea>
            `, [
                { text: 'å–æ¶ˆ', click: closeModal },
                { text: 'ç¡®è®¤', cls: 'btn-primary', click: async () => {
                    const note = document.getElementById('bk-note').value;
                    const inserts = times.map(t => ({
                        equipment_id: state.equipId,
                        user_id: state.user,
                        remarks: note,
                        start_time: t.toISOString(),
                        end_time: t.add(1, 'hour').toISOString()
                    }));
                    const { error } = await supabase.from('bookings').insert(inserts);
                    if(error) alert('é¢„çº¦å¤±è´¥'); else { closeModal(); fetchData(); }
                }}
            ]);
        }

        function showDetail(b) {
            const isMine = b.user_id === state.user;
            const canEdit = isMine || state.isAdmin;
            
            let html = `<p><strong>ç”¨æˆ·ï¼š</strong>${b.user_id}</p>
                        <p><strong>æ—¶é—´ï¼š</strong>${b.start.format('MM-DD HH:mm')}</p>
                        <textarea id="dt-note" style="width:100%" rows="3" ${!canEdit?'disabled':''}>${b.remarks||''}</textarea>`;
            
            let btns = [{ text: 'å…³é—­', click: closeModal }];
            
            if(canEdit) {
                btns.unshift({ text: 'åˆ é™¤', cls: 'btn-danger', click: async () => {
                    if(confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) {
                        await supabase.from('bookings').delete().eq('id', b.id);
                        closeModal(); fetchData();
                    }
                }});
                btns.unshift({ text: 'ä¿å­˜å¤‡æ³¨', cls: 'btn-primary', click: async () => {
                    const note = document.getElementById('dt-note').value;
                    await supabase.from('bookings').update({ remarks: note }).eq('id', b.id);
                    closeModal(); fetchData();
                }});
            }
            
            showModal('é¢„çº¦è¯¦æƒ…', html, btns);
        }

        // --- è¾…åŠ© ---
        function makeDiv(cls, html) {
            const d = document.createElement('div');
            d.className = cls; d.innerHTML = html;
            return d;
        }

        function showMsg(text, isErr) {
            dom.msg.className = 'overlay-msg show';
            dom.msgText.innerHTML = text;
            dom.retryBtn.style.display = isErr ? 'block' : 'none';
        }
        
        function hideMsg() {
            dom.msg.className = 'overlay-msg';
        }

        function checkAdmin() {
            state.isAdmin = state.user === 'admins';
            document.getElementById('admin-btn').style.display = state.isAdmin ? 'block' : 'none';
        }

        function updateStatus() {
            const eq = state.equips.find(e => e.id == state.equipId);
            document.getElementById('st-eq').textContent = eq ? eq.name : '--';
            document.getElementById('st-user').textContent = state.user || '--';
            document.getElementById('status-bar').style.display = 'flex';
        }

        window.toggleLock = async (d, isLocked) => {
            if(isLocked) await supabase.from('locked_dates').delete().eq('equipment_id', state.equipId).eq('lock_date', d);
            else await supabase.from('locked_dates').insert({ equipment_id: state.equipId, lock_date: d });
            fetchData();
        };

        // äº‹ä»¶ç»‘å®š
        document.getElementById('username-btn').onclick = () => {
            const v = document.getElementById('username-inp').value.trim();
            if(!v) return alert('è¯·è¾“å…¥å§“å');
            state.user = v;
            localStorage.setItem('lab-user', v);
            checkAdmin();
            updateStatus();
            // é‡æ–°æ¸²æŸ“æ—¥å†ä»¥æ›´æ–°é¢œè‰²
            render();
            alert('ç”¨æˆ·åå·²æ›´æ–°');
        };

        document.getElementById('admin-btn').onclick = () => {
            let html = `<div style="display:flex;gap:5px;margin-bottom:10px;">
                <input id="new-eq" placeholder="æ–°å™¨æå" style="flex:1;">
                <button class="btn-primary" onclick="addEq()">æ·»åŠ </button>
            </div>
            <div style="max-height:200px;overflow:auto;border:1px solid var(--border);border-radius:4px;">
                ${state.equips.map(e => `<div style="padding:8px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;">
                    <span>${e.name}</span><span onclick="delEq(${e.id})" style="color:red;cursor:pointer;">åˆ é™¤</span>
                </div>`).join('')}
            </div>`;
            
            showModal('ç®¡ç†å™¨æ', html, [{ text: 'å®Œæˆ', click: closeModal }]);
        };

        window.addEq = async () => {
            const name = document.getElementById('new-eq').value;
            if(!name) return;
            await supabase.from('equipment').insert({ name });
            fetchEquipments(); closeModal();
        };
        
        window.delEq = async (id) => {
            if(!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
            await supabase.from('equipment').delete().eq('id', id);
            fetchEquipments(); closeModal();
        };

        document.getElementById('retry-btn').onclick = () => location.reload();
        document.getElementById('refresh-btn').onclick = fetchData;
        dom.eqSel.onchange = (e) => { state.equipId = e.target.value; fetchData(); };
        
        document.getElementById('view-btn').onclick = () => {
            state.mode = state.mode === 'week' ? 'month' : 'week';
            document.getElementById('view-btn').textContent = state.mode === 'week' ? 'æœˆè§†å›¾' : 'å‘¨è§†å›¾';
            fetchData();
        };
        
        document.getElementById('today-btn').onclick = () => { state.date = dayjs(); fetchData(); };
        document.getElementById('w-prev').onclick = () => { state.date = state.date.subtract(1, 'week'); fetchData(); };
        document.getElementById('w-next').onclick = () => { state.date = state.date.add(1, 'week'); fetchData(); };
        document.getElementById('m-prev').onclick = () => { state.date = state.date.subtract(1, 'month'); fetchData(); };
        document.getElementById('m-next').onclick = () => { state.date = state.date.add(1, 'month'); fetchData(); };
        document.getElementById('logout-btn').onclick = () => {
            localStorage.removeItem('lab-auth');
            location.reload();
        };
    </script>
</body>
</html>
