<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®éªŒå®¤å™¨æé¢„çº¦ç³»ç»Ÿ</title>
    
    <!-- 0. åŸç”Ÿ CSS (æ— éœ€ä¸‹è½½) -->
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --text: #334155; --border: #cbd5e1; --red: #ef4444; }
        body { margin: 0; font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }
        
        /* å¸ƒå±€å·¥å…· */
        .flex { display: flex; }
        .hidden { display: none !important; }
        .flex-1 { flex: 1; }
        
        /* é¡¶éƒ¨å¯¼èˆª */
        header { background: white; padding: 10px 15px; border-bottom: 1px solid var(--border); box-shadow: 0 1px 2px rgba(0,0,0,0.05); z-index: 50; }
        .title { font-weight: bold; font-size: 18px; color: var(--primary); margin-right: 15px; }
        
        /* æŒ‰é’®ä¸è¾“å…¥æ¡† */
        button { padding: 5px 12px; border-radius: 4px; border: 1px solid var(--border); background: white; cursor: pointer; font-size: 13px; }
        button:hover { background: #f1f5f9; }
        button.primary { background: var(--primary); color: white; border-color: var(--primary); }
        button.primary:hover { background: #1d4ed8; }
        button.danger { color: var(--red); border-color: #fca5a5; background: #fef2f2; }
        input, select, textarea { padding: 5px; border: 1px solid var(--border); border-radius: 4px; font-size: 13px; }

        /* ä¸»è§†å›¾åŒºåŸŸ */
        main { flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; padding: 10px; }
        
        /* çŠ¶æ€æ¡ */
        #status-bar { background: #eff6ff; padding: 8px; border-radius: 4px; font-size: 12px; color: #1e40af; border: 1px solid #dbeafe; margin-bottom: 10px; display: none; }

        /* ç½‘æ ¼ç³»ç»Ÿ */
        .grid-container { background: white; border: 1px solid var(--border); border-radius: 6px; overflow: auto; flex: 1; position: relative; }
        #week-grid { display: grid; grid-template-columns: 50px repeat(7, minmax(100px, 1fr)); min-height: 100%; }
        #month-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border); min-height: 100%; }

        /* å•å…ƒæ ¼æ ·å¼ */
        .sticky-top { position: sticky; top: 0; background: #f8fafc; z-index: 10; border-bottom: 1px solid var(--border); padding: 8px; text-align: center; font-weight: bold; border-left: 1px solid var(--border); }
        .sticky-left { position: sticky; left: 0; background: #f8fafc; z-index: 5; border-right: 1px solid var(--border); text-align: right; padding: 5px; font-size: 12px; color: #64748b; border-top: 1px solid var(--border); }
        .cell { border-right: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9; height: 40px; position: relative; }
        .month-cell { background: white; min-height: 80px; padding: 5px; }
        
        /* é¢„çº¦å— */
        .event { position: absolute; left: 2px; right: 2px; padding: 2px 4px; font-size: 12px; color: white; border-radius: 3px; cursor: pointer; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; z-index: 2; }
        .event.mine { background: var(--primary); }
        .event.other { background: #eab308; }
        .slot-locked { background: #e2e8f0 repeating-linear-gradient(45deg, transparent, transparent 5px, #fff 5px, #fff 10px); cursor: not-allowed; }

        /* å¼¹çª—ä¸é®ç½© */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        /* åŠ è½½åŠ¨ç”» */
        .spinner { width: 30px; height: 30px; border: 3px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #loading-layer { background: white; z-index: 200; display: flex; flex-direction: column; }
        #load-status { margin-top: 10px; font-size: 12px; color: #64748b; font-family: monospace; }
    </style>

    <!-- 1. ç¨³å¥çš„è„šæœ¬åŠ è½½å™¨ -->
    <script>
        // èµ„æºå®šä¹‰ï¼š[é¦–é€‰æº, å¤‡ç”¨æº1, å¤‡ç”¨æº2]
        const RESOURCES = {
            dayjs: [
                "https://lib.baomitu.com/dayjs/1.11.10/dayjs.min.js", // 360å›½å†…æº
                "https://cdn.staticfile.org/dayjs/1.11.10/dayjs.min.js", // ä¸ƒç‰›äº‘
                "https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js" // å›½é™…é€šç”¨
            ],
            supabase: [
                "https://npm.elemecdn.com/@supabase/supabase-js@2/dist/umd/supabase.js", // é¥¿äº†ä¹ˆæº
                "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js", // å®˜æ–¹CDN
                "https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js" // å¤‡ç”¨
            ]
        };

        const PLUGINS = [
            "plugin/isoWeek.min.js",
            "plugin/utc.min.js",
            "plugin/timezone.min.js",
            "plugin/weekday.min.js"
        ];

        function updateStatus(msg) {
            const el = document.getElementById('load-status');
            if(el) el.innerText = msg;
            console.log(`[System] ${msg}`);
        }

        function loadScript(urls) {
            return new Promise((resolve, reject) => {
                let index = 0;
                function tryLoad() {
                    if (index >= urls.length) return reject();
                    const url = urls[index];
                    updateStatus(`å°è¯•åŠ è½½èµ„æº: ${url.split('/')[2]}...`);
                    
                    const script = document.createElement('script');
                    script.src = url;
                    script.onload = () => resolve(url);
                    script.onerror = () => {
                        console.warn(`Failed to load: ${url}`);
                        index++;
                        tryLoad();
                    };
                    document.head.appendChild(script);
                }
                tryLoad();
            });
        }

        // æ’ä»¶åŠ è½½é€»è¾‘ (åŸºäºæˆåŠŸçš„ Dayjs æº)
        async function loadPlugins(dayjsUrl) {
            // å°è¯•æ¨æ–­ base url
            let baseUrl = dayjsUrl.substring(0, dayjsUrl.lastIndexOf('/') + 1);
            // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœ fallback åˆ°äº† cdnjs ç­‰ç»“æ„ä¸åŒçš„æºï¼Œå¯èƒ½éœ€è¦ç¡¬ç¼–ç å¤‡ç”¨
            const backups = [
                baseUrl,
                "https://lib.baomitu.com/dayjs/1.11.10/",
                "https://cdn.staticfile.org/dayjs/1.11.10/"
            ];

            for (const plugin of PLUGINS) {
                let loaded = false;
                for (const base of backups) {
                    try {
                        await loadScript([base + plugin]);
                        loaded = true;
                        break;
                    } catch(e) {}
                }
                if (!loaded) console.error(`æ’ä»¶ ${plugin} åŠ è½½å¤±è´¥ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™`);
            }
        }

        window.initSystem = async () => {
            try {
                // 1. åŠ è½½ Day.js
                const dayjsUrl = await loadScript(RESOURCES.dayjs);
                updateStatus("Day.js åŠ è½½æˆåŠŸ");

                // 2. åŠ è½½æ’ä»¶
                await loadPlugins(dayjsUrl);
                updateStatus("æ’ä»¶åŠ è½½å®Œæˆ");

                // 3. åŠ è½½ Supabase
                await loadScript(RESOURCES.supabase);
                updateStatus("Supabase åŠ è½½æˆåŠŸ");

                // 4. å¯åŠ¨åº”ç”¨
                if (window.appStart) window.appStart();
                
            } catch (e) {
                updateStatus("é”™è¯¯: æ ¸å¿ƒåº“æ— æ³•åŠ è½½ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚");
                const btn = document.createElement('button');
                btn.innerText = "åˆ·æ–°é‡è¯•";
                btn.className = "primary";
                btn.style.marginTop = "10px";
                btn.onclick = () => location.reload();
                document.getElementById('loading-layer').appendChild(btn);
            }
        };
    </script>
</head>
<body>

    <!-- 1. å¯åŠ¨/åŠ è½½å±‚ -->
    <div id="loading-layer" class="overlay" style="display: flex;">
        <div class="spinner"></div>
        <p style="margin-top:15px; color:#333; font-weight:bold;">ç³»ç»Ÿåˆå§‹åŒ–ä¸­...</p>
        <div id="load-status">å‡†å¤‡è¿æ¥...</div>
    </div>

    <!-- 2. ç™»å½•å±‚ -->
    <div id="login-layer" class="overlay">
        <div class="modal" style="text-align: center;">
            <h2>ğŸ” èº«ä»½éªŒè¯</h2>
            <input type="password" id="access-code" placeholder="è¯·è¾“å…¥ç­çº§å£ä»¤" style="width:100%; margin:15px 0; padding:10px;">
            <button class="primary" style="width:100%; padding:10px;" id="login-btn">è¿›å…¥ç³»ç»Ÿ</button>
            <p id="login-error" style="color:red; display:none; margin-top:10px;">å£ä»¤é”™è¯¯</p>
        </div>
    </div>

    <!-- 3. é¡¶éƒ¨å¯¼èˆª -->
    <header class="flex justify-between items-center">
        <div class="flex items-center gap-2">
            <div class="title">ğŸ”¬ å™¨æé¢„çº¦</div>
            <input id="user-name" placeholder="å§“å" style="width:80px">
            <button id="user-confirm-btn" class="primary">ç¡®è®¤</button>
        </div>
        <div class="flex items-center gap-2" style="flex-wrap: wrap; justify-content: flex-end;">
            <span>å™¨æ:</span>
            <select id="eq-select" style="width:120px"></select>
            <button id="manage-btn" style="display:none;">âš™ï¸</button>
            <button id="refresh-btn" title="åˆ·æ–°">âŸ³</button>
            <div style="width:1px; height:20px; background:var(--border); margin:0 5px;"></div>
            <button id="view-btn" class="primary">æœˆè§†å›¾</button>
            <button id="today-btn">ä»Šå¤©</button>
            <button id="logout-btn" class="danger">é€€å‡º</button>
        </div>
    </header>

    <!-- 4. ä¸»å†…å®¹ -->
    <main>
        <div id="status-bar" class="flex justify-between">
            <span>å½“å‰å™¨æ: <b id="st-eq">--</b></span>
            <span>ç”¨æˆ·: <b id="st-user">--</b></span>
        </div>

        <!-- å‘¨è§†å›¾ -->
        <div id="week-view" class="flex flex-col flex-1">
            <div class="flex justify-between items-center mb-2">
                <button id="w-prev">â† ä¸Šå‘¨</button>
                <strong id="w-title">...</strong>
                <button id="w-next">ä¸‹å‘¨ â†’</button>
            </div>
            <div class="grid-container">
                <div id="week-grid"></div>
            </div>
        </div>

        <!-- æœˆè§†å›¾ -->
        <div id="month-view" class="flex-col flex-1 hidden">
            <div class="flex justify-between items-center mb-2">
                <button id="m-prev">â† ä¸Šæœˆ</button>
                <strong id="m-title">...</strong>
                <button id="m-next">ä¸‹æœˆ â†’</button>
            </div>
            <div class="grid-container">
                <div id="month-grid"></div>
            </div>
        </div>
    </main>

    <!-- 5. é€šç”¨å¼¹çª— -->
    <div id="modal-overlay" class="overlay">
        <div class="modal">
            <h3 id="m-title" style="margin-top:0">æ ‡é¢˜</h3>
            <div id="m-body"></div>
            <div id="m-foot" style="margin-top:20px; text-align:right; display:flex; gap:10px; justify-content:flex-end;"></div>
        </div>
    </div>

    <script>
        // === å¯åŠ¨è„šæœ¬åŠ è½½ ===
        window.initSystem();

        // === é…ç½® ===
        const CFG = {
            url: 'https://ajbuygcpdpiyinttmwdo.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFqYnV5Z2NwZHBpeWludHRtd2RvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NTUyMTYsImV4cCI6MjA3OTUzMTIxNn0.8_cko-69pwVXy-AzWlwwhLxFOV4hvTvkhJoxo9ng06o',
            pass: '123456'
        };

        // å…¨å±€å˜é‡
        let supabase;
        let state = {
            user: localStorage.getItem('lab-user') || '',
            isAdmin: false,
            date: null, 
            equipId: null,
            equips: [], bookings: [], locks: [],
            mode: 'week'
        };

        const get = (id) => document.getElementById(id);

        // === ä¸»ç¨‹åº (åœ¨èµ„æºåŠ è½½åè°ƒç”¨) ===
        window.appStart = () => {
            try {
                // æ³¨å†Œ Dayjs
                dayjs.extend(window.dayjs_plugin_isoWeek);
                dayjs.extend(window.dayjs_plugin_utc);
                dayjs.extend(window.dayjs_plugin_timezone);
                dayjs.extend(window.dayjs_plugin_weekday);
                dayjs.tz.setDefault(dayjs.tz.guess());
                state.date = dayjs().startOf('day');

                // åˆå§‹åŒ– Supabase
                supabase = window.supabase.createClient(CFG.url, CFG.key);
            } catch(e) {
                updateStatus("åˆå§‹åŒ–å¤±è´¥: " + e.message);
                return;
            }

            // ç•Œé¢åˆ‡æ¢
            get('loading-layer').style.display = 'none';
            if (localStorage.getItem('lab-auth') === 'true') {
                initUI();
            } else {
                get('login-layer').style.display = 'flex';
            }
            
            bindEvents();
        };

        // === ç™»å½• ===
        function bindEvents() {
            const loginBtn = get('login-btn');
            if(loginBtn) loginBtn.onclick = () => {
                if (get('access-code').value === CFG.pass) {
                    localStorage.setItem('lab-auth', 'true');
                    get('login-layer').style.display = 'none';
                    initUI();
                } else {
                    get('login-error').style.display = 'block';
                }
            };

            // é¡¶éƒ¨æŒ‰é’®
            get('user-confirm-btn').onclick = () => {
                const v = get('user-name').value.trim();
                if(!v) return alert('è¯·è¾“å…¥å§“å');
                state.user = v; localStorage.setItem('lab-user', v);
                checkAdmin(); updateStatus(); render(); alert('ç”¨æˆ·å·²æ›´æ–°');
            };
            get('logout-btn').onclick = () => { localStorage.removeItem('lab-auth'); location.reload(); };
            get('refresh-btn').onclick = () => fetchEquipments();
            
            // å¯¼èˆª
            get('today-btn').onclick = () => { state.date = dayjs(); fetchData(); };
            get('w-prev').onclick = () => { state.date = state.date.subtract(1, 'week'); fetchData(); };
            get('w-next').onclick = () => { state.date = state.date.add(1, 'week'); fetchData(); };
            get('m-prev').onclick = () => { state.date = state.date.subtract(1, 'month'); fetchData(); };
            get('m-next').onclick = () => { state.date = state.date.add(1, 'month'); fetchData(); };
            get('view-btn').onclick = () => {
                state.mode = state.mode === 'week' ? 'month' : 'week';
                get('view-btn').textContent = state.mode === 'week' ? 'æœˆè§†å›¾' : 'å‘¨è§†å›¾';
                fetchData();
            };
            
            // ç®¡ç†
            get('manage-btn').onclick = openManageModal;
            if(get('eq-select')) get('eq-select').onchange = (e) => { state.equipId = e.target.value; fetchData(); };
        }

        function initUI() {
            if(get('user-name')) get('user-name').value = state.user;
            checkAdmin();
            fetchEquipments();
        }

        // === æ•°æ® ===
        async function fetchEquipments() {
            const { data, error } = await supabase.from('equipment').select('*').order('name');
            if (error) return alert('è·å–å™¨æå¤±è´¥: ' + error.message);
            
            state.equips = data || [];
            const sel = get('eq-select');
            sel.innerHTML = '';

            if (state.equips.length === 0) {
                sel.innerHTML = '<option>æš‚æ— å™¨æ</option>';
                return;
            }

            state.equips.forEach(e => {
                const opt = document.createElement('option');
                opt.value = e.id; opt.text = e.name;
                sel.appendChild(opt);
            });

            if (state.equipId && state.equips.find(e => e.id == state.equipId)) {
                sel.value = state.equipId;
            } else {
                state.equipId = state.equips[0].id;
                sel.value = state.equipId;
            }
            fetchData();
        }

        async function fetchData() {
            if (!state.equipId) return;
            const [bRes, lRes] = await Promise.all([
                supabase.from('bookings').select('*').eq('equipment_id', state.equipId),
                supabase.from('locked_dates').select('lock_date').eq('equipment_id', state.equipId)
            ]);

            if (bRes.error) console.error(bRes.error);
            state.bookings = (bRes.data || []).map(b => ({ ...b, start: dayjs(b.start_time), end: dayjs(b.end_time) }));
            state.locks = (lRes.data || []).map(l => l.lock_date);

            updateStatus();
            render();
        }

        // === æ¸²æŸ“ ===
        function render() {
            if (state.mode === 'week') renderWeek();
            else renderMonth();
        }

        function renderWeek() {
            const grid = get('week-grid');
            grid.innerHTML = '';
            get('week-view').classList.remove('hidden');
            get('month-view').classList.add('hidden');
            get('w-title').textContent = state.date.format('YYYY-MM-DD');

            grid.appendChild(div('sticky-top sticky-left', ''));

            const startWeek = state.date.weekday(0);
            for(let i=0; i<7; i++) {
                const d = startWeek.add(i, 'day');
                const dStr = d.format('YYYY-MM-DD');
                const isLocked = state.locks.includes(dStr);
                const lockIcon = state.isAdmin ? (isLocked ? 'ğŸ”’' : 'ğŸ”“') : (isLocked ? 'ğŸ”’' : '');
                const head = div('sticky-top', `${d.format('MM/DD')} ${lockIcon}`);
                if(state.isAdmin) {
                    head.style.cursor = 'pointer';
                    head.onclick = () => toggleLock(dStr, isLocked);
                }
                grid.appendChild(head);
            }

            for(let h=0; h<24; h++) {
                grid.appendChild(div('sticky-left', `${h}:00`));
                for(let d=0; d<7; d++) {
                    const date = startWeek.add(d, 'day');
                    const isLocked = state.locks.includes(date.format('YYYY-MM-DD'));
                    const cell = div(`cell ${isLocked ? 'slot-locked' : ''}`, '');
                    if(!isLocked) cell.onclick = () => createBooking(date.hour(h));
                    grid.appendChild(cell);
                }
            }

            state.bookings.forEach(b => {
                if(b.start.isBefore(startWeek) || b.start.isAfter(startWeek.add(7, 'day'))) return;
                const col = b.start.diff(startWeek, 'day') + 2;
                const row = b.start.hour() + 2;
                const span = b.end.diff(b.start, 'hour');
                const isMine = b.user_id === state.user;
                const el = div(`event ${isMine ? 'mine' : 'other'}`, `<b>${b.user_id}</b> ${b.remarks||''}`);
                el.style.gridColumn = col;
                el.style.gridRow = `${row} / span ${span}`;
                el.onclick = (e) => { e.stopPropagation(); showDetail(b); };
                grid.appendChild(el);
            });
        }

        function renderMonth() {
            const grid = get('month-grid');
            grid.innerHTML = '';
            get('week-view').classList.add('hidden');
            get('month-view').classList.remove('hidden');
            get('m-title').textContent = state.date.format('YYYYå¹´MMæœˆ');

            ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(t => {
                const d = div('month-cell', t);
                d.style.textAlign = 'center'; d.style.fontWeight = 'bold'; d.style.background = '#f8fafc'; d.style.minHeight = 'auto';
                grid.appendChild(d);
            });

            const startMonth = state.date.startOf('month');
            const startGrid = startMonth.weekday(0);

            for(let i=0; i<42; i++) {
                const d = startGrid.add(i, 'day');
                const isCurr = d.month() === startMonth.month();
                const users = [...new Set(state.bookings.filter(b => b.start.isSame(d, 'day')).map(b => b.user_id))];
                
                const html = `<div style="text-align:right;font-weight:bold;font-size:12px;color:#999">${d.date()}</div>
                              <div>${users.map(u => `<span class="user-tag" style="background:#dbeafe;color:#1e40af;padding:1px 4px;border-radius:3px;font-size:11px;margin:1px;display:inline-block">${u}</span>`).join('')}</div>`;
                const cell = div('month-cell', html);
                if(!isCurr) cell.style.background = '#f1f5f9';
                grid.appendChild(cell);
            }
        }

        // === ä¸šåŠ¡ ===
        async function createBooking(time) {
            if(!state.user || state.user === 'admins') return alert('è¯·å…ˆåœ¨å·¦ä¸Šè§’è¾“å…¥å§“åå¹¶ç¡®è®¤');
            const note = prompt(`é¢„çº¦ ${time.format('MM-DD HH:mm')} (1å°æ—¶)\nè¯·è¾“å…¥å¤‡æ³¨:`);
            if(note === null) return;

            const data = {
                equipment_id: state.equipId,
                user_id: state.user,
                remarks: note,
                start_time: time.toISOString(),
                end_time: time.add(1, 'hour').toISOString()
            };
            const { error } = await supabase.from('bookings').insert(data);
            if(error) alert('é¢„çº¦å¤±è´¥: ' + error.message); else fetchData();
        }

        function showDetail(b) {
            const canEdit = b.user_id === state.user || state.isAdmin;
            let html = `<p>ç”¨æˆ·: ${b.user_id}</p><p>æ—¶é—´: ${b.start.format('MM-DD HH:mm')}</p>
                        <textarea id="dt-note" style="width:100%" rows="3" ${!canEdit?'disabled':''}>${b.remarks||''}</textarea>`;
            
            let btns = [{ text: 'å…³é—­', click: closeModal }];
            if(canEdit) {
                btns.unshift({ text: 'åˆ é™¤', cls: 'danger', click: async () => {
                    if(confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) {
                        await supabase.from('bookings').delete().eq('id', b.id);
                        closeModal(); fetchData();
                    }
                }});
                btns.unshift({ text: 'ä¿å­˜', cls: 'primary', click: async () => {
                    await supabase.from('bookings').update({ remarks: get('dt-note').value }).eq('id', b.id);
                    closeModal(); fetchData();
                }});
            }
            showModal('è¯¦æƒ…', html, btns);
        }

        async function toggleLock(dateStr, isLocked) {
            if(isLocked) await supabase.from('locked_dates').delete().eq('equipment_id', state.equipId).eq('lock_date', dateStr);
            else await supabase.from('locked_dates').insert({ equipment_id: state.equipId, lock_date: dateStr });
            fetchData();
        }

        function openManageModal() {
            const html = `<div style="display:flex;gap:5px;margin-bottom:10px;">
                <input id="new-eq" placeholder="æ–°å™¨æå" style="flex:1">
                <button class="primary" onclick="addEq()">æ·»åŠ </button>
            </div>
            <div style="max-height:200px;overflow:auto;border:1px solid #eee;">
                ${state.equips.map(e => `<div style="padding:8px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;">
                    <span>${e.name}</span><span onclick="delEq(${e.id})" style="color:red;cursor:pointer">åˆ é™¤</span>
                </div>`).join('')}
            </div>`;
            showModal('ç®¡ç†å™¨æ', html, [{ text: 'å®Œæˆ', click: closeModal }]);
        }

        window.addEq = async () => {
            const name = get('new-eq').value;
            if(!name) return;
            await supabase.from('equipment').insert({ name });
            fetchEquipments(); closeModal();
        };
        window.delEq = async (id) => {
            if(confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) { await supabase.from('equipment').delete().eq('id', id); fetchEquipments(); closeModal(); }
        };

        // === è¾…åŠ© ===
        function div(cls, html) { const d=document.createElement('div'); d.className=cls; d.innerHTML=html; return d; }
        function checkAdmin() { state.isAdmin = state.user === 'admins'; get('manage-btn').style.display = state.isAdmin ? 'block' : 'none'; }
        function updateStatus() {
            const eq = state.equips.find(e => e.id == state.equipId);
            get('st-eq').textContent = eq ? eq.name : 'æœªçŸ¥';
            get('status-bar').style.display = 'flex';
            get('st-user').textContent = state.user || 'æœªè®¾ç½®';
        }
        function showModal(title, body, btns) {
            get('m-title').textContent = title;
            get('m-body').innerHTML = body;
            get('m-foot').innerHTML = '';
            btns.forEach(b => {
                const btn = document.createElement('button');
                btn.textContent = b.text;
                if(b.cls) btn.className = b.cls;
                btn.onclick = b.click;
                get('m-foot').appendChild(btn);
            });
            get('modal-overlay').style.display = 'flex';
        }
        function closeModal() { get('modal-overlay').style.display = 'none'; }

    </script>
</body>
</html>
