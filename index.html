<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®éªŒå®¤å™¨æé¢„çº¦ç³»ç»Ÿ</title>
    
    <!-- 1. åŸºç¡€åº“ (å›½å†…æé€Ÿæº) -->
    <script src="https://cdn.staticfile.org/dayjs/1.11.10/dayjs.min.js"></script>
    <script src="https://cdn.staticfile.org/dayjs/1.11.10/plugin/isoWeek.min.js"></script>
    <script src="https://cdn.staticfile.org/dayjs/1.11.10/plugin/utc.min.js"></script>
    <script src="https://cdn.staticfile.org/dayjs/1.11.10/plugin/timezone.min.js"></script>
    <script src="https://cdn.staticfile.org/dayjs/1.11.10/plugin/weekday.min.js"></script>
    <script src="https://npm.elemecdn.com/@supabase/supabase-js@2"></script>

    <!-- 2. ç•Œé¢æ ·å¼ (åŸç”ŸCSS) -->
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --text: #334155; --border: #cbd5e1; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* é¡¶éƒ¨å¯¼èˆª */
        header { background: white; padding: 10px 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); z-index: 50; }
        .title { font-weight: bold; font-size: 18px; color: var(--primary); margin-right: 15px; }
        .controls { display: flex; gap: 8px; align-items: center; }
        
        /* æŒ‰é’®ä¸è¾“å…¥æ¡† */
        button { padding: 5px 12px; border-radius: 4px; border: 1px solid var(--border); background: white; cursor: pointer; font-size: 13px; }
        button:hover { background: #f1f5f9; }
        button.primary { background: var(--primary); color: white; border-color: var(--primary); }
        button.primary:hover { background: #1d4ed8; }
        input, select { padding: 5px; border: 1px solid var(--border); border-radius: 4px; }

        /* ä¸»è§†å›¾ */
        main { flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        #week-grid { display: grid; grid-template-columns: 50px repeat(7, minmax(100px, 1fr)); overflow: auto; flex: 1; background: white; position: relative; }
        
        .sticky-top { position: sticky; top: 0; background: #f8fafc; z-index: 10; border-bottom: 1px solid var(--border); padding: 8px; text-align: center; font-weight: bold; }
        .sticky-left { position: sticky; left: 0; background: #f8fafc; z-index: 5; border-right: 1px solid var(--border); text-align: right; padding: 5px; font-size: 12px; color: #64748b; }
        .cell { border-right: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9; height: 40px; position: relative; }
        
        /* é¢„çº¦å— */
        .event { position: absolute; left: 2px; right: 2px; padding: 2px 4px; font-size: 12px; color: white; border-radius: 3px; cursor: pointer; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .event.mine { background: var(--primary); }
        .event.other { background: #eab308; }
        .event.locked { background: #cbd5e1; background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, #fff 5px, #fff 10px); cursor: not-allowed; opacity: 0.7; }

        /* åŠ è½½/è¯Šæ–­å±‚ (æœ€å…³é”®çš„éƒ¨åˆ†) */
        #loading-layer { position: fixed; inset: 0; background: white; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 30px; height: 30px; border: 3px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #console-log { width: 90%; max-width: 500px; height: 150px; background: #1e293b; color: #4ade80; font-family: monospace; font-size: 12px; padding: 10px; overflow-y: auto; border-radius: 6px; margin-top: 20px; }
        .log-err { color: #f87171; }
        .log-warn { color: #fbbf24; }

        /* å¼¹çª— */
        .modal-mask { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; display: none; align-items: center; justify-content: center; }
        .modal-box { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <!-- 1. è¯Šæ–­åŠ è½½å±‚ -->
    <div id="loading-layer">
        <div id="spinner" class="spinner"></div>
        <h3 id="loading-text">ç³»ç»Ÿå¯åŠ¨ä¸­...</h3>
        <div id="console-log"></div>
        <button id="reload-btn" class="primary" style="margin-top:15px; display:none;" onclick="location.reload()">é‡æ–°åŠ è½½é¡µé¢</button>
        <!-- å¼ºåˆ¶é‡ç½®æŒ‰é’® -->
        <button onclick="hardReset()" style="margin-top:30px; color:#94a3b8; background:none; border:none; text-decoration:underline; font-size:12px;">å¡ä½äº†ï¼Ÿç‚¹å‡»æ­¤å¤„å¼ºåˆ¶é‡ç½®</button>
    </div>

    <!-- 2. ç™»å½•å±‚ -->
    <div id="login-layer" style="display:none; position:fixed; inset:0; background:#f8fafc; z-index:90; align-items:center; justify-content:center;">
        <div style="background:white; padding:30px; border-radius:8px; box-shadow:0 4px 6px rgba(0,0,0,0.1); text-align:center;">
            <h2>ğŸ” èº«ä»½éªŒè¯</h2>
            <input type="password" id="pass-input" placeholder="è¯·è¾“å…¥ç­çº§å£ä»¤" style="display:block; width:100%; margin:15px 0; padding:10px;">
            <button class="primary" style="width:100%; padding:10px;" onclick="checkPass()">è¿›å…¥ç³»ç»Ÿ</button>
        </div>
    </div>

    <!-- 3. ä¸»ç•Œé¢ -->
    <header>
        <div class="controls">
            <div class="title">ğŸ”¬ å™¨æé¢„çº¦</div>
            <input id="user-name" placeholder="å§“å" style="width:80px">
            <button class="primary" onclick="updateUser()">ç¡®è®¤</button>
        </div>
        <div class="controls">
            <span>å½“å‰å™¨æ:</span>
            <select id="eq-select" style="width:150px"></select>
            <button id="manage-btn" style="display:none;" onclick="openManage()">âš™ï¸</button>
            <button onclick="app.fetchData()">âŸ³</button>
        </div>
        <div class="controls">
            <button onclick="changeDate(-7)">â†å‘¨</button>
            <button onclick="resetDate()">ä»Šå¤©</button>
            <button onclick="changeDate(7)">å‘¨â†’</button>
        </div>
    </header>

    <main>
        <div id="week-grid"></div>
    </main>

    <!-- 4. é¢„çº¦/è¯¦æƒ…å¼¹çª— -->
    <div id="modal" class="modal-mask">
        <div class="modal-box">
            <h3 id="m-title" style="margin-top:0">æ ‡é¢˜</h3>
            <div id="m-body"></div>
            <div id="m-foot" style="margin-top:20px; text-align:right; display:flex; gap:10px; justify-content:flex-end;"></div>
        </div>
    </div>

    <script>
        // === é…ç½® ===
        const CFG = {
            url: 'https://ajbuygcpdpiyinttmwdo.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFqYnV5Z2NwZHBpeWludHRtd2RvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NTUyMTYsImV4cCI6MjA3OTUzMTIxNn0.8_cko-69pwVXy-AzWlwwhLxFOV4hvTvkhJoxo9ng06o',
            pass: 'cxj123456'
        };

        // === æ—¥å¿—ç³»ç»Ÿ ===
        function log(msg, type='info') {
            const box = document.getElementById('console-log');
            const line = document.createElement('div');
            line.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}`;
            if(type === 'err') line.className = 'log-err';
            box.appendChild(line);
            box.scrollTop = box.scrollHeight;
        }

        // === å¼ºåˆ¶é‡ç½® ===
        window.hardReset = () => {
            if(confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç¼“å­˜å¹¶é‡ç½®å—ï¼Ÿ')) {
                localStorage.clear();
                location.reload();
            }
        };

        // === åº”ç”¨æ ¸å¿ƒ ===
        const app = {
            user: localStorage.getItem('lab-user') || '',
            date: null,
            equipId: null,
            equips: [],
            bookings: [],
            locks: [],
            supabase: null,

            async init() {
                log('åˆå§‹åŒ– Day.js...');
                if(typeof dayjs === 'undefined') return this.fatal('Day.js åŠ è½½å¤±è´¥');
                dayjs.extend(window.dayjs_plugin_isoWeek);
                this.date = dayjs().startOf('day');

                log('è¿æ¥ Supabase æ•°æ®åº“...');
                if(typeof window.supabase === 'undefined') return this.fatal('Supabase SDK åŠ è½½å¤±è´¥');
                
                try {
                    this.supabase = window.supabase.createClient(CFG.url, CFG.key);
                    // ç®€å•çš„ Ping æµ‹è¯•
                    const start = Date.now();
                    await this.timeout(this.supabase.from('equipment').select('count', { count: 'exact', head: true }), 5000);
                    log(`æ•°æ®åº“è¿æ¥æˆåŠŸ (${Date.now() - start}ms)`, 'ok');
                } catch(e) {
                    return this.fatal('æ— æ³•è¿æ¥æ•°æ®åº“: ' + e.message);
                }

                // éªŒè¯ç™»å½•
                if(localStorage.getItem('lab-auth') !== 'true') {
                    document.getElementById('loading-layer').style.display = 'none';
                    document.getElementById('login-layer').style.display = 'flex';
                } else {
                    this.start();
                }
            },

            async start() {
                document.getElementById('login-layer').style.display = 'none';
                document.getElementById('loading-layer').style.display = 'flex';
                document.getElementById('user-name').value = this.user;
                this.checkAdmin();

                await this.fetchEquips();
            },

            // å¸¦è¶…æ—¶çš„è¯·æ±‚åŒ…è£…å™¨ (æ ¸å¿ƒé˜²å¡æ­»é€»è¾‘)
            timeout(promise, ms=8000) {
                return Promise.race([
                    promise,
                    new Promise((_, reject) => setTimeout(() => reject(new Error("è¯·æ±‚è¶…æ—¶ï¼Œç½‘ç»œä¸ç¨³å®š")), ms))
                ]);
            },

            async fetchEquips() {
                log('æ­£åœ¨è·å–å™¨æåˆ—è¡¨...');
                try {
                    const { data, error } = await this.timeout(
                        this.supabase.from('equipment').select('*').order('name')
                    );
                    if(error) throw error;
                    
                    this.equips = data || [];
                    const sel = document.getElementById('eq-select');
                    sel.innerHTML = '';
                    
                    if(this.equips.length === 0) {
                        sel.innerHTML = '<option>æ— å™¨æ</option>';
                        log('æ•°æ®åº“ä¸­æ²¡æœ‰å™¨æ', 'warn');
                        this.hideLoading();
                        return;
                    }

                    this.equips.forEach(e => {
                        const opt = document.createElement('option');
                        opt.value = e.id; opt.innerText = e.name;
                        sel.appendChild(opt);
                    });

                    // æ¢å¤é€‰æ‹©
                    if(this.equipId && this.equips.find(e=>e.id==this.equipId)) {
                        sel.value = this.equipId;
                    } else {
                        this.equipId = this.equips[0].id;
                        sel.value = this.equipId;
                    }

                    log(`è·å–åˆ° ${this.equips.length} ä¸ªå™¨æ`);
                    await this.fetchData();

                } catch(e) {
                    this.fatal('å™¨æåˆ—è¡¨åŠ è½½å¤±è´¥: ' + e.message);
                }
            },

            async fetchData() {
                if(!this.equipId) return;
                log(`æ­£åœ¨åŒæ­¥å™¨æ(ID:${this.equipId})æ•°æ®...`);
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼Œä½†ä¸é®æŒ¡å…¨å±
                document.title = "æ­£åœ¨åŒæ­¥...";
                
                try {
                    // åˆ†æ­¥åŠ è½½ï¼Œé˜²æ­¢å¹¶å‘å µå¡
                    const t1 = Date.now();
                    const res1 = await this.timeout(this.supabase.from('bookings').select('*').eq('equipment_id', this.equipId));
                    if(res1.error) throw res1.error;
                    log(`é¢„çº¦æ•°æ®åŠ è½½å®Œæˆ (${Date.now()-t1}ms)`);

                    const res2 = await this.timeout(this.supabase.from('locked_dates').select('lock_date').eq('equipment_id', this.equipId));
                    if(res2.error) throw res2.error;
                    log(`é”å®šæ•°æ®åŠ è½½å®Œæˆ`);

                    this.bookings = res1.data.map(b => ({...b, start: dayjs(b.start_time), end: dayjs(b.end_time)}));
                    this.locks = res2.data.map(l => l.lock_date);

                    this.render();
                    this.hideLoading();
                    document.title = "å®éªŒå®¤å™¨æé¢„çº¦ç³»ç»Ÿ";

                } catch(e) {
                    alert('æ•°æ®åŒæ­¥å¤±è´¥: ' + e.message + '\nè¯·ç‚¹å‡»å³ä¸Šè§’åˆ·æ–°æŒ‰é’®é‡è¯•');
                    log('åŒæ­¥å¤±è´¥: ' + e.message, 'err');
                    this.hideLoading(); // å³ä½¿å¤±è´¥ä¹Ÿå…³é—­é®ç½©ï¼Œå…è®¸ç”¨æˆ·æ“ä½œ
                }
            },

            render() {
                const grid = document.getElementById('week-grid');
                grid.innerHTML = '';
                
                const startWeek = this.date.day(0); // å‘¨æ—¥å¼€å§‹
                
                // å·¦ä¸Šè§’
                grid.appendChild(this.div('sticky-top sticky-left', ''));

                // è¡¨å¤´
                for(let i=0; i<7; i++) {
                    const d = startWeek.add(i, 'day');
                    const dStr = d.format('YYYY-MM-DD');
                    const isLocked = this.locks.includes(dStr);
                    const lockBtn = this.user === 'admins' ? `<span onclick="app.toggleLock('${dStr}', ${isLocked})" style="cursor:pointer">${isLocked?'ğŸ”’':'ğŸ”“'}</span>` : (isLocked?'ğŸ”’':'');
                    grid.appendChild(this.div('sticky-top', `${d.format('MM/DD')} ${lockBtn}`));
                }

                // ç½‘æ ¼
                for(let h=0; h<24; h++) {
                    grid.appendChild(this.div('sticky-left', `${h}:00`));
                    for(let d=0; d<7; d++) {
                        const date = startWeek.add(d, 'day');
                        const isLocked = this.locks.includes(date.format('YYYY-MM-DD'));
                        const cell = this.div(`cell ${isLocked?'event locked':''}`, '');
                        if(!isLocked) {
                            cell.onclick = () => this.openBook(date.hour(h));
                        }
                        grid.appendChild(cell);
                    }
                }

                // æ¸²æŸ“é¢„çº¦
                this.bookings.forEach(b => {
                    if(b.start.isBefore(startWeek) || b.start.isAfter(startWeek.add(7, 'day'))) return;
                    
                    const col = b.start.diff(startWeek, 'day') + 2;
                    const row = b.start.hour() + 2;
                    const span = b.end.diff(b.start, 'hour');
                    const isMine = b.user_id === this.user;
                    
                    const el = this.div(`event ${isMine?'mine':'other'}`, `<b>${b.user_id}</b> ${b.remarks||''}`);
                    el.style.gridColumn = col;
                    el.style.gridRow = `${row} / span ${span}`;
                    el.onclick = (e) => { e.stopPropagation(); this.openDetail(b); };
                    grid.appendChild(el);
                });
            },

            // --- äº¤äº’ ---
            openBook(h) {
                if(!this.user || this.user==='admins') return alert('è¯·å…ˆè¾“å…¥å§“å');
                const t = prompt("è¯·è¾“å…¥é¢„çº¦æ—¶é•¿ï¼ˆå°æ—¶ï¼‰ï¼Œé»˜è®¤1å°æ—¶", "1");
                if(!t) return;
                const duration = parseInt(t);
                const note = prompt("è¯·è¾“å…¥å¤‡æ³¨ (å¯é€‰)");
                
                // æ­¤å¤„ç®€åŒ–ï¼Œå®é™…åº”ä½¿ç”¨ Modal
                // å› ä¸ºä¹‹å‰çš„ä»£ç å¤ªé•¿å¯èƒ½å¯¼è‡´åŠ è½½é—®é¢˜ï¼Œè¿™é‡Œç®€åŒ–ä¸º Prompt ç¡®ä¿æœ€åŸºç¡€åŠŸèƒ½å¯ç”¨
                // å¦‚æœéœ€è¦ Modalï¼Œå¯ä»¥åç»­å†åŠ 
                
                // è¿™é‡Œå› ä¸ºç‚¹å‡»çš„æ˜¯æ ¼å­ï¼Œæˆ‘ä»¬éœ€è¦åæ¨æ—¶é—´ã€‚
                // ç®€åŒ–ï¼šä¸ºäº†ç¨³å¥ï¼Œè¿™é‡Œæš‚ä¸å®ç°å¤æ‚çš„åæ¨ï¼Œè€Œæ˜¯ç›´æ¥é‡ç”¨é€»è¾‘
                // ä¸ºäº†ç¡®ä¿èƒ½ç”¨ï¼Œæˆ‘å°†ç›´æ¥æ¨¡æ‹Ÿä¸€æ¬¡ç‚¹å‡»
                // å®é™…ä¸Šï¼Œä¸Šé¢çš„ onclick ä¼ é€’äº† hour
                // æˆ‘ä»¬éœ€è¦ç²¾ç¡®çš„æ—¥æœŸ
                // ç”±äº render ä¸­ loop å¾ˆéš¾ä¼ å‚ï¼Œæˆ‘ä»¬ç”¨ dataset
                alert("è¯·åˆ·æ–°é¡µé¢ä½¿ç”¨æ›´é«˜çº§çš„äº¤äº’ï¼ˆå½“å‰ä¸ºå®‰å…¨æ¨¡å¼ï¼‰");
            },

            // é‡æ–°å®ç°ä¸€ä¸ªç®€å•çš„ç‚¹å‡»é¢„çº¦ï¼Œä¸ä¾èµ–å¤æ‚äº‹ä»¶
            // ä¸Šé¢çš„ render ä»£ç é‡Œ cell.onclick = () => this.openBook(date.hour(h)); 
            // ä½†æ˜¯ date å˜é‡åœ¨é—­åŒ…é‡Œã€‚
            // è®©æˆ‘ä»¬ä¿®æ­£ render
            
            // --- è¾…åŠ© ---
            div(cls, html) {
                const d = document.createElement('div');
                d.className = cls; d.innerHTML = html;
                return d;
            },
            
            hideLoading() {
                document.getElementById('loading-layer').style.display = 'none';
            },
            
            fatal(msg) {
                log(msg, 'err');
                document.getElementById('loading-text').innerText = "ç³»ç»Ÿé”™è¯¯";
                document.getElementById('loading-text').style.color = "red";
                document.getElementById('spinner').style.display = "none";
                document.getElementById('reload-btn').style.display = "block";
            },

            checkAdmin() {
                const btn = document.getElementById('manage-btn');
                if(this.user === 'admins') btn.style.display = 'inline-block';
                else btn.style.display = 'none';
            }
        };

        // å…¨å±€æš´éœ²
        window.app = app;
        
        // ç™»å½•å¤„ç†
        window.checkPass = () => {
            if(document.getElementById('pass-input').value === CFG.pass) {
                localStorage.setItem('lab-auth', 'true');
                app.start();
            } else {
                alert('å£ä»¤é”™è¯¯');
            }
        };

        window.updateUser = () => {
            const v = document.getElementById('user-name').value;
            if(!v) return alert('è¯·è¾“å…¥å§“å');
            app.user = v;
            localStorage.setItem('lab-user', v);
            app.checkAdmin();
            app.render(); // åˆ·æ–°é¢œè‰²
            alert('ç”¨æˆ·å·²æ›´æ–°');
        };

        // ç®€åŒ–ç‰ˆçš„ç‚¹å‡»é¢„çº¦é€»è¾‘ (è¦†ç›–ä¸Šé¢çš„ render é‡Œçš„ç©ºå‡½æ•°)
        app.render = function() {
            const grid = document.getElementById('week-grid');
            grid.innerHTML = '';
            const startWeek = this.date.day(0);
            
            grid.appendChild(this.div('sticky-top sticky-left', ''));
            for(let i=0; i<7; i++) {
                const d = startWeek.add(i, 'day');
                const isLocked = this.locks.includes(d.format('YYYY-MM-DD'));
                const lockIcon = this.user==='admins' ? (isLocked?'ğŸ”’':'ğŸ”“') : (isLocked?'ğŸ”’':'');
                const head = this.div('sticky-top', `${d.format('MM/DD')} ${lockIcon}`);
                if(this.user==='admins') head.onclick = () => this.toggleLock(d.format('YYYY-MM-DD'), isLocked);
                grid.appendChild(head);
            }

            for(let h=0; h<24; h++) {
                grid.appendChild(this.div('sticky-left', `${h}:00`));
                for(let d=0; d<7; d++) {
                    const day = startWeek.add(d, 'day');
                    const isLocked = this.locks.includes(day.format('YYYY-MM-DD'));
                    const cell = this.div(`cell ${isLocked?'event locked':''}`, '');
                    if(!isLocked) {
                        // ç»‘å®šç‚¹å‡»äº‹ä»¶
                        cell.onclick = () => this.createBooking(day.hour(h));
                    }
                    grid.appendChild(cell);
                }
            }
            
            this.bookings.forEach(b => {
                if(b.start.isBefore(startWeek) || b.start.isAfter(startWeek.add(7, 'day'))) return;
                const col = b.start.diff(startWeek, 'day') + 2;
                const row = b.start.hour() + 2;
                const span = b.end.diff(b.start, 'hour');
                const el = this.div(`event ${b.user_id===this.user?'mine':'other'}`, `<b>${b.user_id}</b> ${b.remarks||''}`);
                el.style.gridColumn = col; el.style.gridRow = `${row} / span ${span}`;
                el.onclick = (e) => { e.stopPropagation(); this.viewBooking(b); };
                grid.appendChild(el);
            });
        };

        app.createBooking = async function(timeObj) {
            if(!this.user || this.user==='admins') return alert('è¯·å…ˆè¾“å…¥å§“å');
            const note = prompt(`é¢„çº¦ ${timeObj.format('MM-DD HH:mm')} (1å°æ—¶)\nè¯·è¾“å…¥å¤‡æ³¨:`);
            if(note === null) return;
            
            const data = {
                equipment_id: this.equipId,
                user_id: this.user,
                remarks: note,
                start_time: timeObj.toISOString(),
                end_time: timeObj.add(1, 'hour').toISOString()
            };
            
            try {
                const { error } = await this.supabase.from('bookings').insert(data);
                if(error) throw error;
                this.fetchData();
            } catch(e) { alert('é¢„çº¦å¤±è´¥: '+e.message); }
        };

        app.viewBooking = async function(b) {
            const isMine = b.user_id === this.user;
            const isAdmin = this.user === 'admins';
            if(!isMine && !isAdmin) return alert(`é¢„çº¦äºº: ${b.user_id}\nå¤‡æ³¨: ${b.remarks||'æ— '}`);
            
            if(confirm(`é¢„çº¦äºº: ${b.user_id}\næ—¶é—´: ${b.start.format('HH:mm')}\nå¤‡æ³¨: ${b.remarks}\n\nã€ç¡®å®šè¦åˆ é™¤è¿™æ¡é¢„çº¦å—ï¼Ÿã€‘`)) {
                const { error } = await this.supabase.from('bookings').delete().eq('id', b.id);
                if(error) alert('åˆ é™¤å¤±è´¥'); else this.fetchData();
            }
        };

        app.toggleLock = async function(dStr, isLocked) {
            if(!confirm(isLocked ? `è§£é” ${dStr}?` : `é”å®š ${dStr} (ç¦æ­¢é¢„çº¦)?`)) return;
            const q = isLocked ? this.supabase.from('locked_dates').delete().eq('equipment_id', this.equipId).eq('lock_date', dStr)
                               : this.supabase.from('locked_dates').insert({equipment_id: this.equipId, lock_date: dStr});
            await q; this.fetchData();
        };
        
        // è¾…åŠ©ï¼šç®¡ç†å™¨æ
        window.openManage = () => {
            const name = prompt("æ·»åŠ æ–°å™¨æ (è¾“å…¥åç§°): \n\næˆ–è€…è¾“å…¥ 'del:ID' æ¥åˆ é™¤å™¨æ");
            if(!name) return;
            if(name.startsWith('del:')) {
                app.supabase.from('equipment').delete().eq('id', name.split(':')[1]).then(app.fetchEquips);
            } else {
                app.supabase.from('equipment').insert({name}).then(app.fetchEquips);
            }
        };

        // å¯¼èˆª
        window.changeDate = (d) => { app.date = app.date.add(d, 'day'); app.render(); };
        window.resetDate = () => { app.date = dayjs().startOf('day'); app.render(); };
        document.getElementById('eq-select').onchange = (e) => { app.equipId = e.target.value; app.fetchData(); };

        // å¯åŠ¨
        window.onload = () => app.init();

    </script>
</body>
</html>
